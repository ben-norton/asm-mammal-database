var adminParams,adminPreloadSearch,createDuplicateTaxon,createNewTaxon,deleteTaxon,deprecatedHelper,fetchEditorDropdownContent,fillEmptyCommonName,handleDragDropImage,licenseHelper,loadAdminUi,loadModalTaxonEditor,lookupEditorSpecies,newColumnHelper,prefetchEditorDropdowns,renderAdminSearchResults,renderDeprecatedFromDatabase,saveEditorEntry,validateCitation,validateNewTaxon,verifyLoginCredentials,indexOf=[].indexOf||function(e){for(var a=0,t=this.length;a<t;a++)if(a in this&&this[a]===e)return a;return-1};(adminParams={}).apiTarget="admin-api.php",adminParams.adminPageUrl="https://mammaldiversity.org/admin-page.html",adminParams.loginDir="admin/",adminParams.loginApiTarget=adminParams.loginDir+"async_login_handler.php",loadAdminUi=function(){var e;console.log("Loading admin UI");try{verifyLoginCredentials(function(e){var a,t,n,i;return t=uri.domain+"_name",a=uri.domain+"_fullname",adminParams.cookieName=t,adminParams.cookieFullName=a,n='<h3 class="col-xs-12">\n  Welcome, '+$.cookie(t)+'\n  <span id="pib-wrapper-settings" class="pib-wrapper" data-toggle="tooltip" title="User Settings" data-placement="bottom">\n    <paper-icon-button icon=\'settings-applications\' class=\'click\' data-url=\''+e.login_url+'\'></paper-icon-button>\n  </span>\n  <span id="pib-wrapper-exit-to-app" class="pib-wrapper" data-toggle="tooltip" title="Go to SADB app" data-placement="bottom">\n    <paper-icon-button icon=\'exit-to-app\' class=\'click\' data-url=\''+uri.urlString+"' id=\"app-linkout\"></paper-icon-button>\n  </span>\n</h3>\n<div id='admin-actions-block' class=\"col-xs-12\">\n  <div class='bs-callout bs-callout-info'>\n    <p>Please be patient while the administrative interface loads.</p>\n  </div>\n</div>",$("main #main-body").html(n),bindClicks(),i='<form id="admin-search-form" onsubmit="event.preventDefault()" class="row">\n  <div class="col-xs-7 col-sm-8">\n    <paper-input label="Search for species" id="admin-search" name="admin-search" required autofocus floatingLabel></paper-input>\n  </div>\n  <div class="col-xs-2 col-lg-1">\n    <paper-fab id="do-admin-search" icon="search" raisedButton class="asm-blue"></paper-fab>\n  </div>\n  <div class="col-xs-2 col-lg-1">\n    <paper-fab id="do-admin-add" icon="add" raisedButton class="asm-blue" title="Create New Taxon" data-toggle="tooltip"></paper-fab>\n  </div>\n  <div class="col-offset-lg-2">\n    \x3c!-- Placeholder --\x3e\n  </div>\n</form>\n<div id=\'search-results\' class="row"></div>',$("#admin-actions-block").html("<div class='col-xs-12'>"+i+"</div>"),$("#admin-search-form").submit(function(e){return e.preventDefault()}),$("#admin-search").keypress(function(e){if(13===e.which)return renderAdminSearchResults()}),$("#do-admin-search").click(function(){return renderAdminSearchResults()}),$("#do-admin-add").click(function(){return createNewTaxon()}),bindClickTargets(),console.info("Successfully validated user"),!1})}catch(a){e=a,console.error("Couldn't check status - "+e.message),console.warn(e.stack),$("main #main-body").html("<div class='bs-callout bs-callout-danger col-xs-12'><h4>Application Error</h4><p>There was an error in the application. Please refresh and try again. If this persists, please contact administration.</p></div>")}return!1},verifyLoginCredentials=function(e){var a,t,n,i,r;try{n=$.cookie(uri.domain+"_auth"),r=$.cookie(uri.domain+"_secret"),i=$.cookie(uri.domain+"_link")}catch(e){t=e,console.warn("Unable to verify login credentials: "+t.message),console.debug(t.stack)}return a="hash="+n+"&secret="+r+"&dblink="+i,$.post(adminParams.loginApiTarget,a,"json").done(function(a){var t;return console.log("Server called back from login credential verification",a),!0!==a.status?($(".logged-in-values").remove(),"function"==typeof e&&!0!==_asm.inhibitRedirect?isNull(a.login_url)?$("main #main-body").html("<div class='bs-callout-danger bs-callout col-xs-12'><h4>Couldn't verify login</h4><p>There's currently a server problem. Try back again soon.</p><p>The server said:</p><code>"+a.error+"</code></div>"):goTo(a.login_url):console.log("Login credentials checked -- not logged in")):($(".logged-in-values").removeAttr("hidden"),$(".logged-in-hidden").attr("hidden","hidden"),t=uri.domain+"_fullname",$("header .fill-user-fullname").text($.cookie(t)),"function"==typeof e?e(a):void 0)}).fail(function(e,a){return $("main #main-body").html("<div class='bs-callout-danger bs-callout col-xs-12'><h4>Couldn't verify login</h4><p>There's currently a server problem. Try back again soon.</p></div>"),console.log(e,a),!1}),!1},renderAdminSearchResults=function(e,a){var t,n,i,r;if(null==a&&(a="#search-results"),r=$("#admin-search").val(),isNull(r)){if("object"!=typeof e)return toastStatusMessage("Please enter a search term"),!1;r=e.genus+" "+e.species}return animateLoad(),$("#admin-search").blur(),r=r.replace(/\./g,""),r=prepURI(r.toLowerCase()),t="q="+r+"&loose=true",n=Base64.encodeURI(r),i=uri.urlString+"#"+n,$("#app-linkout").attr("data-url",i),$.get(searchParams.targetApi,t,"json").done(function(e){var t,n,i,o,s,l,d,c,u,p,m,g,h,b,f,v,y,w,x,_,k,T,C,S,L,N;if(!0!==e.status||0===e.count)return stopLoadError(),isNull(e.human_error)?toastStatusMessage("Your search returned no results. Please try again."):toastStatusMessage(e.human_error),!1;o=e.result,l="",d="<table id='cndb-result-list' class='table table-striped table-hover'>\n\t<thead class='cndb-row-headers'>",C=toInt(e.count)-1,i=null,t=0,k=["id","genus","species","subspecies"],w=o,o={};for(u in w)for(T=w[u],o[u]={},f=0,b=4;f<b;f++)g=k[f],o[u][g]=T[g];for(u in o){if(T=o[u],0===toInt(u)){p=0,d+="\n\x3c!-- Table Headers - "+Object.size(T)+" entries --\x3e",console.debug("Got row",T);for(m in T)T[m],y=m.replace(/_/g," "),"genus"!==m&&"species"!==m&&"subspecies"!==m||(d+="\n\t\t<th class='text-center'>"+y+"</th>",t++),++p===Object.size(T)&&(d+="\n\t\t<th class='text-center'>Edit</th>",t++,d+="\n\t\t<th class='text-center'>Delete</th>",t++,d+="\n\t\t<th class='text-center'>View</th>\n\t</thead>",t++,d+="\n\x3c!-- End Table Headers --\x3e",console.log("Got "+t+" display columns."),i="col-md-"+roundNumber(12/t,0))}L=T.genus.trim()+"+"+T.species.trim(),isNull(T.subspecies)||(L=L+"+"+T.subspecies.trim()),c="\n\t<tr id='cndb-row"+u+"' class='cndb-result-entry' data-taxon=\""+L+'">',h=0;for(m in T){if(n=T[m],isNull(T.genus))return!0;"genus"!==m&&"species"!==m&&"subspecies"!==m||(c+="\n\t\t<td id='"+m+"-"+u+"' class='"+m+" "+i+"'><span>"+n+"</span></td>"),++h===Object.size(T)&&(c+="\n\t\t<td id='edit-"+u+"' class='edit-taxon "+i+" text-center'><paper-icon-button icon='image:edit' class='edit' data-taxon='"+L+"'></paper-icon-button></td>",c+="\n\t\t<td id='delete-"+u+"' class='delete-taxon "+i+" text-center'><paper-icon-button icon='icons:delete-forever' class='delete-taxon-button fadebg' data-taxon='"+L+"' data-database-id='"+T.id+"'></paper-icon-button></td>",c+="\n\t\t<td id='visit-listing-"+u+"' class='view-taxon "+i+" text-center'><paper-icon-button icon='icons:visibility' class='view-taxon-button fadebg click' data-href='"+uri.urlString+"species-account.php?genus="+T.genus.trim()+"&species="+T.species.trim()+"' data-newtab='true'></paper-icon-button></td>",l+=c+="\n\t</tr>")}if(toInt(u)===C){l=d+l+"</table>",$(a).html(l),console.log("Processed "+(toInt(u)+1)+" rows"),$(".edit").click(function(){var e;return e=$(this).attr("data-taxon"),lookupEditorSpecies(e)}),$(".delete-taxon-button").click(function(){var e;return $(this).attr("data-taxon"),e=$(this).attr("data-database-id"),deleteTaxon(e)}),bindClicks();try{S={genus:(N=r.split(" "))[0],species:null!=(x=N[1])?x:"",subspecies:null!=(_=N[2])?_:""},s=jsonTo64(S);try{v=uri.o.attr("base")+uri.o.attr("path"),setHistory(v+"#"+s)}catch(e){}}catch(e){}stopLoad()}}}).fail(function(e,a){var n;return console.error("There was an error performing the search"),console.warn(e,n,e.statusText),console.warn(searchParams.targetApi+"?"+t),n=e.status+"::"+e.statusText,stopLoadError("Couldn't execute the search - "+n)})},fetchEditorDropdownContent=function(e,a,t,n){var i;return null==e&&(e="simple_linnean_goup"),null==t&&(t=!0),null==n&&(n=!0),"object"!=typeof("undefined"!=typeof _asm&&null!==_asm?_asm.dropdownPopulation:void 0)&&("object"!=typeof _asm&&(window._asm={}),_asm.dropdownPopulation={}),i=e.replace(/\_/g,"-"),isNull(a)&&(a=e.replace(/\_/g," ").toTitleCase()),_asm.dropdownPopulation[e]={html:'<paper-input label="'+a+'" id="edit-'+i+'" name="edit-'+i+'" class="'+e+'" floatingLabel></paper-input>'},$.get(searchParams.targetApi,"get_unique=true&col="+e,"json").done(function(r){var o,s,l,d,c,u,p;if(!0!==r.status)return console.warn("Didn't get a valid set of values for column '"+e+"': "+r.error),!1;for(l="",d=0,s=(p=Object.toArray(r.values)).length;d<s;d++)l+='<paper-item data-value="'+(u=p[d])+'" data-column="'+e+'">'+u+"</paper-item>\n";return o='<section class="row filled-editor-dropdown">\n<div class="col-xs-9">\n  <paper-dropdown-menu label="'+a+'" id="edit-'+i+'" name="edit-'+i+'" class="'+e+'" data-column="'+e+'">\n    <paper-listbox class="dropdown-content">\n      '+l+'\n    </paper-listbox>\n  </paper-dropdown-menu>\n</div>\n<div class="col-xs-3">\n  <paper-icon-button class="add-col-value" data-column='+e+' icon="icons:add-circle" title="Add new '+a+'" data-toggle="tooltip"></paper-icon-button>\n</div>\n</section>',n&&(_asm.dropdownPopulation[e]={values:p,html:o,selector:"#edit-"+i}),t&&(c="#edit-"+i,$(c).exists()&&$(c).replaceWith(o)),!1}).fail(function(t,n){return console.warn("Unable to get dropdown content for '"+e+"'"),console.warn(t,n),_asm.dropdownPopulation[e]={html:'<paper-input label="'+a+'" id="edit-'+i+'" name="edit-'+i+'" class="'+e+'" floatingLabel></paper-input>'}}),!1},licenseHelper=function(e){return null==e&&(e="#edit-image-license-dialog"),$(e).unbind(),_asm._setLicenseDialog=function(a){var t,n,i,r,o;return r=$(a).attr("data-column"),isNull(r)?(console.error("Unable to show dialog -- invalud column designator"),!1):(console.debug("Add column fired -- target is "+r),$("paper-dialog#set-license-value").remove(),t=$(e).attr("data-license-name"),n=$(e).attr("data-license-url"),i='<paper-dialog id="set-license-value" data-column="'+r+'" modal>\n  <h2>Set License</h2>\n  <paper-dialog-scrollable>\n    <paper-input class="new-license-name license-field" label="License Name" floatingLabel autofocus value="'+t+'" required autovalidate></paper-input>\n    <paper-input class="new-license-url license-field" label="License URL" floatingLabel value="'+n+'" required autovalidate></paper-input>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Cancel</paper-button>\n    <paper-button class="add-value">Set</paper-button>\n  </div>\n</paper-dialog>',$("body").append(i),o="((?:https?)://(?:(?:(?:[0-9]+\\.){3}[0-9]+|(?:[0-9a-f]+:){6,8}|(?:[\\w~\\-]{2,}\\.)+[\\w]{2,}|localhost))/?(?:[\\w~\\-]*/?)*(?:(?:\\.\\w+)?(?:\\?(?:\\w+=\\w+&?)*)?))(?:#[\\w~\\-]+)?",p$("paper-input.new-license-url").pattern=o,p$("paper-input.new-license-url").errorMessage="This must be a valid URL",p$("paper-input.new-license-name").errorMessage="This cannot be empty",_asm._updateLicense=function(){var e;return $("paper-icon-button#edit-image-license-dialog").attr("data-license-name",p$("paper-input.new-license-name").value).attr("data-license-url",p$("paper-input.new-license-url").value),e=p$("paper-input.new-license-name").value+" @ "+p$("paper-input.new-license-url").value,p$("#edit-image-license").value=e,$("#edit-image-license").attr("data-license-name",p$("paper-input.new-license-name").value).attr("data-license-url",p$("paper-input.new-license-url").value),p$("#set-license-value").close(),!1},$("#set-license-value paper-button.add-value").click(function(){var e,a,t,n,i;for(a=!0,n=0,t=(i=$("#set-license-value .license-field")).length;n<t;n++)e=i[n],p$(e).validate(),p$(e).invalid&&(a=!1);if(!a)return!1;console.debug("isReady",a);try{_asm._updateLicense.debounce(50)}catch(e){console.warn("Couldn't debounce save new col call"),stopLoadError("There was a problem saving this data")}return!1}),$("#set-license-value").on("iron-overlay-opened",function(){return p$(this).refit(),delay(100,function(e){return function(){return p$(e).refit()}}(this))}),p$("#set-license-value").open(),!1)},$(e).click(function(){return console.debug("Set License clicked"),_asm._setLicenseDialog.debounce(50,null,null,this),!1})},newColumnHelper=function(e){return null==e&&(e=".add-col-value"),$(e).unbind(),_asm._addColumnDialog=function(e){var a,t;return t=$(e).attr("data-column"),isNull(t)?(console.error("Unable to show dialog -- invalud column designator"),!1):(console.debug("Add column fired -- target is "+t),$("paper-dialog#add-column-value").remove(),a='<paper-dialog id="add-column-value" data-column="'+t+'" modal>\n  <h2>Add New <code>'+t.replace(/[\_-]/g," ")+'</code> Value</h2>\n  <paper-dialog-scrollable>\n    <paper-input class="new-col-value" label="Data Value" floatingLabel autofocus></paper-input>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Cancel</paper-button>\n    <paper-button class="add-value">Add</paper-button>\n  </div>\n</paper-dialog>',$("body").append(a),_asm._saveNewCol=function(){var e,a,n;return n=$("#add-column-value paper-input.new-col-value").val(),console.log("Going to test and add '"+n+"'"),indexOf.call(_asm.dropdownPopulation[t].values,n)>=0?(console.warn("Invalid value: already exists"),p$("#add-column-value paper-input.new-col-value").errorMessage="This value already exists",p$("#add-column-value paper-input.new-col-value").invalid=!0,p$("#add-column-value").refit(),!1):((e=document.createElement("paper-item")).setAttribute("data-value",n),e.setAttribute("data-column",t),e.textContent=n,'<paper-item data-value="'+n+'" data-column="'+t+'">'+n+"</paper-item>\n",_asm.dropdownPopulation[t].values.push(n),_asm.dropdownPopulation[t].values.sort(),a=p$("paper-dropdown-menu[data-column='"+t+"'] paper-listbox"),Polymer.dom(a).appendChild(e),delay(250,function(){return $("paper-dropdown-menu[data-column='"+t+"']").polymerSelected(n,!0),p$("#add-column-value").close()}),!1)},$("#add-column-value paper-button.add-value").click(function(){try{_asm._saveNewCol.debounce(50)}catch(e){console.warn("Couldn't debounce save new col call"),stopLoadError("There was a problem saving this data")}return!1}),$("#add-column-value paper-input").keyup(function(e){if(13===(e.keyCode?e.keyCode:e.which))try{_asm._saveNewCol.debounce(50)}catch(e){console.warn("Couldn't debounce save new col call"),stopLoadError("There was a problem saving this data")}return!1}),p$("#add-column-value").open(),!1)},$(e).click(function(){return console.debug("Add column clicked"),_asm._addColumnDialog.debounce(50,null,null,this),!1})},prefetchEditorDropdowns=function(){var e,a;a={major_type:"Clade (eg., boreoeutheria)",major_subtype:"Sub-Clade (eg., euarchontoglires)",linnean_order:null,linnean_family:null,linnean_tribe:null,linnean_subfamily:null,simple_linnean_group:"Common Group (eg., metatheria)",simple_linnean_subgroup:"Common type (eg., bat)"};for(e in a)fetchEditorDropdownContent(e,a[e]);return!1},window.prefetchEditorDropdowns=prefetchEditorDropdowns,loadModalTaxonEditor=function(e,a){var t,n,i;null==e&&(e=""),null==a&&(a="Save"),i=(new Date).toISOString().split("T")[0],n='<paper-dialog modal id=\'modal-taxon-edit\' entry-animation="scale-up-animation" exit-animation="fade-out-animation">\n  <h2 id="editor-title">Taxon Editor</h2>\n  <paper-dialog-scrollable id=\'modal-taxon-editor\'>\n    '+('<paper-input label="Genus" id="edit-genus" name="edit-genus" class="genus" floatingLabel></paper-input>\n<paper-input label="Species" id="edit-species" name="edit-species" class="species" floatingLabel></paper-input>\n<paper-input label="Subspecies" id="edit-subspecies" name="edit-subspecies" class="subspecies" floatingLabel></paper-input>\n<paper-input label="Common Name" id="edit-common-name" name="edit-common-name"  class="common_name" floatingLabel></paper-input>\n<paper-input label="Common Name Source" id="edit-common-name-source" name="edit-common-name-source"  class="common_name_source" floatingLabel readonly></paper-input>\n<div class="row">\n  <paper-input label="Deprecated Scientific Names" id="edit-deprecated-scientific" name="edit-depreated-scientific" floatingLabel aria-describedby="deprecatedHelp" data-column="deprecated_scientific" class="col-xs-10" readonly></paper-input>\n  <div class="col-xs-2">\n    <paper-icon-button icon="icons:create" id="fire-deprecated-editor" title="Edit deprecated scientifics" data-toggle="tooltip"></paper-icon-button>\n  </div>\n  <span class="help-block col-xs-12" id="deprecatedHelp">Click the edit button to fill the old names.</span>\n</div>\n'+_asm.dropdownPopulation.major_type.html+"\n"+_asm.dropdownPopulation.major_subtype.html+"\n"+_asm.dropdownPopulation.linnean_order.html+"\n"+_asm.dropdownPopulation.linnean_family.html+"\n"+_asm.dropdownPopulation.linnean_subfamily.html+"\n"+_asm.dropdownPopulation.linnean_tribe.html+"\n"+_asm.dropdownPopulation.simple_linnean_group.html+"\n"+_asm.dropdownPopulation.simple_linnean_subgroup.html+'\n<paper-input label="Genus authority" id="edit-genus-authority" name="edit-genus-authority" class="genus_authority" floatingLabel></paper-input>\n<paper-input label="Genus authority year" id="edit-gauthyear" name="edit-gauthyear" floatingLabel></paper-input>\n<paper-input label="Genus authority citation" id="edit-genus-authority-citation" name="edit-genus-authority-citation" class="citation-input" floatingLabel></paper-input>\n<iron-label>\n  Use Parenthesis for Genus Authority\n  <paper-toggle-button id="genus-authority-parens"  checked="false"></paper-toggle-button>\n</iron-label>\n<paper-input label="Species authority" id="edit-species-authority" name="edit-species-authority" class="species_authority" floatingLabel></paper-input>\n<paper-input label="Species authority year" id="edit-sauthyear" name="edit-sauthyear" floatingLabel></paper-input>\n<paper-input label="Species authority citation" id="edit-species-authority-citation" name="edit-species-authority-citation" class="citation-input" floatingLabel></paper-input>\n<iron-label>\n  Use Parenthesis for Species Authority\n  <paper-toggle-button id="species-authority-parens" checked="false"></paper-toggle-button>\n</iron-label>\n<br/><br/>\n<paper-input label="ASM ID Number" id="edit-internal-id" name="edit-internal-id" floatingLabel></paper-input>\n<br/>\n<span class="help-block" id="notes-help">You can write your notes and entry in Markdown. (<a href="https://daringfireball.net/projects/markdown/syntax" "onclick=\'window.open(this.href); return false;\' onkeypress=\'window.open(this.href); return false;\'">Official Full Syntax Guide</a>)</span>\n<br/><br/>\n<h3 class=\'text-muted\'>Taxon Notes <small>(optional)</small></h3>\n<iron-autogrow-textarea id="edit-notes" rows="5" aria-describedby="notes-help" placeholder="Notes" class="markdown-region"  data-md-field="notes-markdown-preview">\n  <textarea placeholder="Notes" id="edit-notes-textarea" name="edit-notes-textarea" aria-describedby="notes-help" rows="5"></textarea>\n</iron-autogrow-textarea>\n<marked-element id="notes-markdown-preview" class="markdown-preview">\n  <div class="markdown-html"></div>\n</marked-element>\n<br/><br/>\n<h3 class=\'text-muted\'>Main Taxon Entry</h3>\n<iron-autogrow-textarea id="edit-entry" rows="5" aria-describedby="notes-help" placeholder="Entry" class="markdown-region" data-md-field="entry-markdown-preview">\n  <textarea placeholder="Entry" id="edit-entry-textarea" name="edit-entry-textarea" aria-describedby="entry-help" rows="5"></textarea>\n</iron-autogrow-textarea>\n<marked-element id="entry-markdown-preview" class="markdown-preview">\n  <div class="markdown-html"></div>\n</marked-element>\n<paper-input label="Data Source" id="edit-source" name="edit-source" floatingLabel></paper-input>\n<paper-input label="Data Citation (Markdown Allowed)" id="edit-citation" name="edit-citation" floatingLabel></paper-input>\n<div id="upload-image"></div>\n<span class="help-block" id="upload-image-help">You can drag and drop an image above, or enter its server path below.</span>\n<paper-input label="Image" id="edit-image" name="edit-image" floatingLabel aria-describedby="imagehelp"></paper-input>\n  <span class="help-block" id="imagehelp">The image path here should be relative to the <code>public_html/</code> directory. Check the preview below.</span>\n<paper-input label="Image Caption" id="edit-image-caption" name="edit-image-caption" floatingLabel></paper-input>\n<paper-input label="Image Credit" id="edit-image-credit" name="edit-image-credit" floatingLabel></paper-input>\n<section class="row license-region">\n  <div class="col-xs-9">\n    <paper-input label="Image License" id="edit-image-license" name="edit-image-license" data-license-name="" data-license-url="" floatingLabel readonly></paper-input>\n  </div>\n  <div class="col-xs-3">\n    <paper-icon-button icon="icons:create" id="edit-image-license-dialog" data-license-name="" data-license-url="" data-column="image_license" data-toggle=\'tooltip\' title="Edit License"></paper-icon-button>\n  </div>\n</section>\n<paper-input label="Taxon Credit" id="edit-taxon-credit" name="edit-taxon-credit" floatingLabel aria-describedby="taxon-credit-help" value="'+$.cookie(adminParams.cookieFullName)+'"></paper-input>\n<paper-input label="Taxon Credit Date" id="edit-taxon-credit-date" name="edit-taxon-credit-date" floatingLabel value="'+i+'"></paper-input>\n<span class="help-block" id="taxon-credit-help">This will be displayed as "Entry by <span class=\'taxon-credit-preview\'></span> on <span class=\'taxon-credit-date-preview\'></span>."</span>\n'+e+'\n<input type="hidden" name="edit-taxon-author" id="edit-taxon-author" value="" />')+"\n  </paper-dialog-scrollable>\n  <div class=\"buttons\">\n    <paper-button id='close-editor' dialog-dismiss>Cancel</paper-button>\n    <paper-button id='duplicate-taxon'>Duplicate</paper-button>\n    <paper-button id='save-editor'>"+a+"</paper-button>\n  </div>\n</paper-dialog>",$("#modal-taxon-edit").exists()&&$("#modal-taxon-edit").remove(),$("#search-results").after(n);try{newColumnHelper()}catch(e){t=e,console.warn("Couldn't bind columns: "+t.message),console.warn(t.stack)}try{licenseHelper()}catch(e){t=e,console.warn("Couldn't set license helper: "+t.message),console.warn(t.stack)}try{deprecatedHelper(),$("#fire-deprecated-editor").click(function(){var e;return e=p$("#edit-deprecated-scientific"),_asm._setDeprecatedDialog.debounce(null,null,null,e)})}catch(e){t=e,console.warn("Couldn't set deprecated helper: "+t.message),console.warn(t.stack)}try{$(".citation-input").keyup(function(){return validateCitation(this)})}catch(e){}return handleDragDropImage(),$("#modal-taxon-edit").unbind(),d$("#save-editor").unbind(),d$("#duplicate-taxon").unbind().click(function(){return createDuplicateTaxon()})},deprecatedHelper=function(e){return null==e&&(e="#edit-deprecated-taxon-dialog"),$(e).unbind(),_asm._setDeprecatedDialog=function(e){var a,t,n,i,r,o,s,l,d,c,u,p,m,g;return g=$(e).attr("data-column"),isNull(g)?(console.error("Unable to show dialog -- invalud column designator"),!1):(console.debug("Setup deprecated fired -- target is "+g),i="#set-deprecated-taxa",$(i).remove(),t={genus:null!=(l=p$("#edit-genus").value)?l:"",species:null!=(d=p$("#edit-species").value)?d:""},n={genus:{authority:null!=(c=p$("#edit-genus-authority").value)?c:"",year:null!=(u=p$("#edit-gauthyear").value)?u:"",parens:p$("#genus-authority-parens").checked?"checked":""},species:{authority:null!=(p=p$("#edit-species-authority").value)?p:"",year:null!=(m=p$("#edit-gauthyear").value)?m:"",parens:p$("#species-authority-parens").checked?"checked":""}},_asm._updateDeprecatedListItem=function(e){var a,t,n,i,r,o,s,l,d,c;null==e&&(e=void 0),isNull(e)&&(e=$("#deprecated-taxon-json").val());try{r=JSON.parse(decode64(e)),console.log("Rendering with",r),s=[];for(l in r){n=r[l];try{l=l.replace(/\-/g," ")}catch(e){}a=(t=n.split(":"))[0],c=t[1].split("$"),d=" "+l+' <iron-icon icon="icons:arrow-forward"></iron-icon> '+a.toTitleCase()+" in "+c[0],s.push(d)}o="<li>"+s.join("</li>\n<li>")+"</li>"}catch(e){i=e,console.warn("Didn't parse JSON: "+i.message),console.warn(i.stack),o="<em>No deprecated identifiers</em>"}return o},o=$("#edit-deprecated-scientific").attr("data-json"),s=_asm._updateDeprecatedListItem(o),r='<paper-dialog id="set-deprecated-taxa" data-column="'+g+'" modal>\n  <h2>Set Deprecated Taxa</h2>\n  <paper-dialog-scrollable>\n    <div class="row">\n      <h3 class="col-xs-12">Alternate Taxon Names</h3>\n      <ul id="deprecated-taxon-list" class="col-xs-11 col-xs-offset-1">\n        '+s+'\n      </ul>\n      <input type="hidden" value="'+o+'" id="deprecated-taxon-json"/>\n    </div>\n    <div class="form">\n      <div class="row update-old-taxon">\n        <paper-input class="col-xs-12" value="'+t.genus+'" label="Old Genus" placeholder="'+t.genus+'" id="dialog-update-genus" required autovalidate></paper-input>\n        <paper-input class="col-xs-12" value="'+t.species+'" label="Old Species" placeholder="'+t.species+'" id="dialog-update-species" required autovalidate></paper-input>\n        <paper-input class="col-xs-6" value="'+n.genus.authority+'" label="Old Authority" placeholder="'+n.genus.authority+'" required autovalidate floatingLabel id="dialog-update-authority"></paper-input>\n        <paper-input class="col-xs-6" value="'+n.genus.year+'" label="Old Year" placeholder="'+n.genus.year+'" pattern="[0-9]{4}" error-message="Invalid Year" required autovalidate floatingLabel id="dialog-update-year"></paper-input>\n        <paper-input class="col-xs-6" value="'+n.genus.year+'" label="Year Assigned" placeholder="'+n.genus.year+'" pattern="[0-9]{4}" error-message="Invalid Year" required autovalidate floatingLabel id="dialog-update-citeyear"></paper-input>\n      </div>\n      <div class="row">\n        <div class="col-xs-12 text-right pull-right">\n          <button class="btn btn-primary" id="add-to-json-list">Add To List</button>\n        </div>\n      </div>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Cancel</paper-button>\n    <paper-button class="add-value">Set</paper-button>\n  </div>\n</paper-dialog>',$("body").append(r),p$(i).open(),a=function(){var e,a,n,r,o,l,d,c,u,p,m,g;for(e=!0,d=0,l=(m=$(i+" paper-input")).length;d<l;d++)a=m[d],p$(a).errorMessage="This field can't be empty",p$(a).validate(),p$(a).invalid&&(e=!1);if(!e)return!1;o=$("#deprecated-taxon-json").val();try{"object"!=typeof(n=JSON.parse(decode64(o)))&&(n={})}catch(e){n={}}return u={genus:p$("#dialog-update-genus").value.trim().toTitleCase(),species:p$("#dialog-update-species").value.trim(),authority:p$("#dialog-update-authority").value.trim(),year:toInt(p$("#dialog-update-year").value.trim()),citeYear:toInt(p$("#dialog-update-citeyear").value.trim())},t.genus.toLowerCase()===u.genus.toLowerCase()&&t.species.toLowerCase()===u.species.toLowerCase()?(console.warn("Taxon is the same as the primary"),p$("#dialog-update-genus").errorMessage="This name is the same as the current one",p$("#dialog-update-genus").invalid=!0,p$("#dialog-update-species").errorMessage="This name is the same as the current one",p$("#dialog-update-species").invalid=!0,!1):(1707,g=new Date,u.year<1707||u.year>g.getFullYear()?(console.warn("Invalid year"),p$("#dialog-update-year").errorMessage="The year must be after 1707 and on or before "+g.getFullYear(),p$("#dialog-update-year").invalid=!0,!1):(p=u.genus+" "+u.species,c=u.authority+":"+u.year+"$"+u.citeYear,console.log("Got strings",p,c),n[p]=c,console.log("Object:",n),r=JSON.stringify(n),console.log("Stringified:",r),$("#deprecated-taxon-json").val(encode64(r)),s=_asm._updateDeprecatedListItem(),$("#deprecated-taxon-list").html(s),!1))},$(i+" #add-to-json-list").click(function(){return a.debounce(75),!1}),_asm._updateDeprecated=function(){var a,t,n;return t=$("#deprecated-taxon-json").val(),a=isNull(t)?"{}":decode64(t),n=a.slice(1,-1),p$(e).value=n,!1},$(i+" .buttons paper-button.add-value").click(function(){return _asm._updateDeprecated.debounce(),p$(""+i).close(),!1}),!1)},!1},renderDeprecatedFromDatabase=function(){return!1},fillEmptyCommonName=function(){return!1},validateNewTaxon=function(){var e,a,t,n;return t=function(e){var a,t,n;for(null==e&&(e=!0),a=["genus","species","subspecies"],t=0,3;t<3;t++)n="#edit-"+a[t],e?(p$(n).invalid=!0,p$(n).errorMessage="This taxon already exists in the database",p$("#save-editor").disabled=!0):(p$(n).invalid=!1,p$("#save-editor").disabled=!1);return!1},a={genus:p$("#edit-genus").value,species:p$("#edit-species").value,subspecies:isNull(p$("#edit-subspecies").value)?"":p$("#edit-subspecies").value},e="q="+a.genus+"+"+a.species,n=a.genus+" "+a.species,isNull(a.subspecies)||(e+="+"+a.subspecies,n+=" "+a.subspecies),$.get(searchParams.apiPath,e+"&dwc_only=true","json").done(function(n){var i,r,o,s;if(!0!==n.status)return console.error("Problem validating taxon:",n),!1;for(r=0,i=(o=Object.toArray(n.result)).length;r<i;r++)if((s=o[r]).genus.toLowerCase()===a.genus.toLowerCase()&&s.specificEpithet.toLowerCase()===a.species.toLowerCase())try{if(isNull(a.subspecies)&&isNull(s.subspecificEpithet))return console.warn("Taxon sp already exists in DB"),t();if(a.subspecies.toLowerCase()===s.subspecificEpithet.toLowerCase())return console.warn("Taxon ssp already exists in DB"),t();continue}catch(e){}return t(!1),e="missing=true&genus="+a.genus+"&species="+a.species+"&prefetch=true",$.get(searchParams.apiPath,e,"json").done(function(e){var a,t,n,i,r,o,s,l;if(!isNumeric(e.id))return console.error("Unable to find IUCN result"),!1;t=null!=(o=(r=e).main_common_name)?o:r.common_name,s=r.species_authority,n=r.genus_authority;try{a=JSON.parse(r.authority_year),i=Object.keys(a)[0],l=a[i]}catch(e){i="",l=""}p$("#edit-common-name").value=t,p$("#edit-common-name-source").value="iucn",p$("#edit-genus-authority").value=n,p$("#edit-species-authority").value=s,p$("#edit-gauthyear").value=i,p$("#edit-sauthyear").value=l;try{p$("#genus-authority-parens").checked=r.parens_auth_genus.toBool(),p$("#species-authority-parens").checked=r.parens_auth_species.toBool()}catch(e){}return console.log("Got",t,s,n,a,i,l),!1}),!1}).fail(function(e,a){return console.error("FAIL_VALIDATE"),!1}),!1},createNewTaxon=function(){var e,a;animateLoad(),loadModalTaxonEditor("","Create"),d$("#editor-title").text("Create New Taxon"),a=.5*$(window).height(),d$("#modal-taxon-editor").css("min-height",a+"px"),d$("#modal-taxon-editor div.scrollable").css("max-height",""),d$("#modal-taxon-edit").addClass("create-new-taxon"),d$("#duplicate-taxon").remove(),e=isNull($.cookie(uri.domain+"_fullname"))?$.cookie(uri.domain+"_user"):$.cookie(uri.domain+"_fullname"),d$("#edit-taxon-author").attr("value",e),d$("#save-editor").click(function(){return saveEditorEntry("new")}),$("#modal-taxon-edit").on("iron-overlay-opened",function(){var e,a,t,n,i,r,o,s,l;for(console.log("Binding new taxon events"),e=["genus","species","subspecies"],n=0,3;n<3;n++)l="#edit-"+e[n],$(l).keyup(function(){return validateNewTaxon.debounce()});try{for(a=$(p$("#edit-entry").textarea).val(),r=$(p$("#edit-notes").textarea).val(),p$("#entry-markdown-preview").markdown=a,p$("#notes-markdown-preview").markdown=r,i=0,t=(o=$(".markdown-region")).length;i<t;i++)s=o[i],$(p$(s).textarea).keyup(function(){var e,a;e=$(this).val(),a=$(this).parents("iron-autogrow-textarea").attr("data-md-field");try{return p$("#"+a).markdown=e,console.debug("Wrote markdown to target '#"+a+"'")}catch(t){return t,console.warn("Can't update preview for target '#"+a+"'",$(this).get(0),e)}})}catch(e){e,console.error("Couldn't run markdown previews")}return validateNewTaxon()});try{p$("#modal-taxon-edit").open()}catch(e){$("#modal-taxon-edit").get(0).open()}return stopLoad()},createDuplicateTaxon=function(){var e,a,t,n,i,r;animateLoad();try{for(d$("#taxon-id").remove(),d$("#last-edited-by").remove(),d$("#duplicate-taxon").remove(),d$("#editor-title").text("Create Duplicate Taxon"),i='<paper-button id="save-editor">Create</paper-button>',d$("#save-editor").replaceWith(i),d$("#save-editor").click(function(){return saveEditorEntry("new")}),delay(250,function(){return stopLoad()}),n=0,t=(a=["genus","species","subspecies"]).length;n<t;n++)r="#edit-"+a[n],$(r).keyup(function(){return validateNewTaxon.debounce()});validateNewTaxon()}catch(a){e=a,stopLoadError("Unable to duplicate taxon"),console.error("Couldn't duplicate taxon! "+e.message),d$("#modal-taxon-edit").get(0).close()}return!0},lookupEditorSpecies=function(e){var a,t,n,i,r,o,s,l,d,c;if(null==e&&(e=void 0),null==e)return!1;if(animateLoad(),i="<p id=\"last-edited-by\">\n  Last edited by <span id=\"taxon-author-last\" class=\"capitalize\"></span>\n</p>\n<input type='hidden' name='taxon-id' id='taxon-id'/>",loadModalTaxonEditor(i),d$("#save-editor").click(function(){return saveEditorEntry()}),d$("#last-edited-by").exists()||d$("#taxon-credit-help").after(i),o=void 0,r=void 0,a="q="+e,-1!==e.search(/\(/)){for(r={genus:"",species:"",subspecies:""},o={genus:"",species:"",subspecies:""},d=e.split("+"),n=0;n<d.length;){switch(c=d[n],console.log("Checking '"+c+"'"),toInt(n)){case 0:t=c.split("("),console.log("Looking at genus array",t),r.genus=t[0].trim(),o.genus=null!=t[1]?t[1].trim().slice(0,-1):t[0];break;case 1:s=c.split("("),console.log("Looking at species array",s),r.species=s[0].trim(),o.species=null!=s[1]?s[1].trim().slice(0,-1):s[0];break;case 2:l=c.split("("),console.log("Looking at ssp array",l),r.subspecies=l[0].trim(),o.subspecies=null!=l[1]?l[1].trim().slice(0,-1):l[0];break;default:console.error("K value of '"+n+"' didn't match 0,1,2!")}d[n]=c.trim(),n++}e=r.genus+"+"+r.species,isNull(r.subspecies)||(e+=r.subspecies),a="q="+e+"&loose=true",console.warn("Bad name! Calculated out:"),console.warn("Should be currently",o),console.warn("Was previously",r),console.warn("Pinging with",""+uri.urlString+searchParams.targetApi+"?q="+e)}return $.get(searchParams.targetApi,a,"json").done(function(a){var t,n,i,s,l,d,c,u,p,m,g,h,b,f,v,y,w,x,_,k,T,C;try{if(console.debug("Admin lookup rending editor UI for",a),null==(s=a.result[0]))return stopLoadError("Sorry, there was a problem parsing the information for this taxon. If it persists, you may have to fix it manually."),console.error("No data returned for",searchParams.targetApi+"?q="+e),!1;try{s.deprecated_scientific=JSON.parse(s.deprecated_scientific)}catch(e){d=e}null!=r&&(toastStatusMessage("Bad information found. Please review and resave."),s.genus=o.genus,s.species=o.species,s.subspecies=o.subspecies,"object"!=typeof s.deprecated_scientific&&(s.deprecated_scientific={}),b=r.species,isNull(r.subspecies)||(b+=" "+r.subspecies),s.deprecated_scientific[r.genus.toTitleCase()+" "+b]="AUTHORITY: YEAR"),x=["parens_auth_genus","parens_auth_species"],console.debug("Using data",s),console.debug(JSON.stringify(s));for(t in s){i=s[t];try{"string"==typeof i&&(i=i.trim())}catch(e){}"id"===t&&$("#taxon-id").attr("value",i),n=!1;try{l="#edit-"+t.replace(/\_/g,"-"),"paper-dropdown-menu"===$(l).get(0).tagName.toLowerCase()&&(n=!0)}catch(e){}if(console.debug("Col editor exists for '"+l+"'?",n),n&&(console.debug("Trying to polymer-select",i),$(l).polymerSelected(i,!0)),"species_authority"!==t&&"genus_authority"!==t||/[0-9]{4}/im.test(i)&&(/^\(? *((['"])? *([\w\u00C0-\u017F\. \-\&;\[\]]+(,|&|&amp;|&amp;amp;|&#[\w0-9]+;)?)+ *\2) *, *([0-9]{4}) *\)?/im,(_=/^\(? *((['"]?) *(?:(?:\b|[\u00C0-\u017F])[a-z\u00C0-\u017F\u2019 \.\-\[\]\?]+(?:,|,? *&|,? *&amp;| *&amp;amp;| *&(?:[a-z]+|#[0-9]+);)? *)+ *\2) *, *([0-9]{4}) *\)?/gim).test(i)&&(u=i.search(/\(/)>=0&&i.search(/\)/)>=0,C=i.replace(_,"$3"),i=i.replace(_,"$1"),"genus_authority"===t&&$("#edit-gauthyear").attr("value",C),"species_authority"===t&&$("#edit-sauthyear").attr("value",C),u&&(p$("#"+t.replace(/\_/g,"-")+"-parens").checked=!0))),"authority_year"===t)"object"==typeof(C=parseTaxonYear(i))&&($("#edit-gauthyear").attr("value",C.genus),$("#edit-sauthyear").attr("value",C.species));else if(indexOf.call(x,t)>=0)f="parens"===t.split("_")[0]?"#"+t.split("_").pop()+"-authority-parens":"#"+t.replace(/_/g,"-"),d$(f).polymerChecked(toInt(i).toBool());else if("taxon_author"===t)"null"===i||isNull(i)?($("#last-edited-by").remove(),console.warn("Removed #last-edited-by! Didn't have an author provided for column '"+t+"', giving '"+i+"'. It's probably the first edit to this taxon.")):d$("#taxon-author-last").text(i),k=isNull($.cookie(uri.domain+"_fullname"))?$.cookie(uri.domain+"_user"):$.cookie(uri.domain+"_fullname"),d$("#edit-taxon-author").attr("value",k);else if("taxon_credit"===t)c="#edit-"+t.replace(/_/g,"-"),p$(c).value=$.cookie(adminParams.cookieFullName);else if("image_license"===t){m=i.unescape();try{p=JSON.parse(m);for(g in p){h=p[g],$("#edit-image-license-dialog").attr("data-license-name",g).attr("data-license-url",h),$("#edit-image-license").attr("data-license-name",g).attr("data-license-url",h),i=g+" @ "+h;break}}catch(e){i=m}p$("#edit-image-license").value=i}else if("taxon_credit_date"===t)isNull(i)&&(w=new Date,i=w.toISOString().split("T")[0],c="#edit-"+t.replace(/_/g,"-"),p$(c).value=i);else{if(c="#edit-"+t.replace(/_/g,"-"),"deprecated_scientific"===t){try{$(c).attr("data-json",encode64(JSON.stringify(i)))}catch(e){}i=JSON.stringify(i).trim().replace(/\\/g,""),i=i.replace(/{/,""),'""'===(i=i.replace(/}/,""))&&(i="")}try{"string"==typeof i&&(i=i.unescape())}catch(e){}v=["notes","entry"],indexOf.call(v,t)<0?d$(c).attr("value",i):(T=.9*$("#modal-taxon-edit").width(),d$(c).css("width",T+"px"),y=p$(c).textarea,$(y).text(i.unescape()))}}return p$("#modal-taxon-edit"),$("#modal-taxon-edit").on("iron-overlay-opened",function(){var e,a,t,n,i,r,o,s,l,c;p$("#modal-taxon-edit").refit(),o=p$("#edit-common-name").value,$("#edit-common-name").keyup(function(){var e;return console.debug("Common name field edited!"),e=p$(this).value!==o?"user:"+$.cookie(adminParams.cookieFullName):"iucn",p$("#edit-common-name-source").value=e,!1}),_asm.updateImageField=function(e){var a,t;return a=p$(e).value,console.log("Should render preview image of ",a),$("#preview-main-image").exists()&&$("#preview-main-image").remove(),t='<img id="preview-main-image" class=\'preview-image\' src="'+a+'" />',$("#imagehelp").after(t),!1},$("#edit-image").on("focus",function(){var e;return e=this,_asm.updateImageField.debounce(null,null,null,e),!1}).on("blur",function(){var e;return e=this,_asm.updateImageField.debounce(null,null,null,e),!1}).on("keyup",function(){var e;return e=this,_asm.updateImageField.debounce(null,null,null,e),!1});try{_asm.updateImageField(p$("#edit-image"))}catch(e){}for(i=function(e){var a;return a=p$(e).value,$("#taxon-credit-help .taxon-credit-preview").text(a),a},e=function(e){var a,t,n;return a=p$(e).value,t=new Date(a),n=t.getUTCDate()+" "+dateMonthToString(t.getUTCMonth())+" "+t.getUTCFullYear(),$("#taxon-credit-help .taxon-credit-date-preview").text(n),n},$("#edit-taxon-credit").keyup(function(){return i(this),!1}),$("#edit-taxon-credit-date").keyup(function(){return e(this),!1}),i(p$("#edit-taxon-credit")),e(p$("#edit-taxon-credit-date")),a=$(p$("#edit-entry").textarea).val(),r=$(p$("#edit-notes").textarea).val(),p$("#entry-markdown-preview").markdown=a,p$("#notes-markdown-preview").markdown=r,c=[],n=0,t=(s=$(".markdown-region")).length;n<t;n++)l=s[n],c.push($(p$(l).textarea).keyup(function(){var e,a;e=$(this).val(),a=$(this).parents("iron-autogrow-textarea").attr("data-md-field");try{return p$("#"+a).markdown=e,console.debug("Wrote markdown to target '#"+a+"'")}catch(t){return d=t,console.warn("Can't update preview for target '#"+a+"'",$(this).get(0),e)}}));return c}),safariDialogHelper("#modal-taxon-edit"),stopLoad()}catch(e){return d=e,stopLoadError("Unable to populate the editor for this taxon - "+d.message),console.error("Error populating the taxon popup -- "+d.message),console.warn(d.stack)}}).fail(function(e,a){return stopLoadError("There was a server error populating this taxon. Please try again.")}),!1},validateCitation=function(e){var a,t,n,i,r,o,s;r=!1;try{$(e).exists()&&(s=e,"function"==typeof p$(e).validate?(r=!0,e=p$(s).value):e=$(s).val())}catch(e){}return a=function(e,a){return r&&(!1===e?p$(s).errorMessage="Please enter a valid DOI or ISBN":isNull(a)||(p$(s).value=a),p$(s).invalid=!e),e},t=/^(?:doi:|https?:\/\/dx.doi.org\/)?(10.\d{4,9}\/[-._;()\/:A-Z0-9]+|10.1002\/[^\s]+|10.\d{4}\/\d+-\d+X?(\d+)\d+<[\d\w]+:[\d\w]*>\d+.\d+.\w+;\d|10.1207\/[\w\d]+\&\d+_\d+)$/im,t.test(e)?(o=e.replace(t,"$1"),a(!0,o)):0===e.search(/isbn/i)?(n=/^(?:ISBN(?:-10)?:?\ )?(?=[0-9X]{10}$|(?=(?:[0-9]+[-\ ]){3})[-\ 0-9X]{13}$)[0-9]{1,5}[-\ ]?[0-9]+[-\ ]?[0-9]+[-\ ]?[0-9X]$/,i=/^(?:ISBN(?:-13)?:?\ )?(?=[0-9]{13}$|(?=(?:[0-9]+[-\ ]){4})[-\ 0-9]{17}$)97[89][-\ ]?[0-9]{1,5}[-\ ]?[0-9]+[-\ ]?[0-9]+[-\ ]?[0-9]$/,a(n.test(e)&&i.test(e))):a(!1)},saveEditorEntry=function(e){var a,t,n,i,r,o,s,l,d,c,u,p,m,g,h,b,f,v,y,w,x,_,k,T,C,S,L,N,D,E,P,I,A,j,O,U,M,F,R,Y,B,J,q,z,G,H,W,V,X;null==e&&(e="save"),y=["genus","species","subspecies","common-name","major-type","major-subtype","linnean-order","linnean-family","simple-linnean-group","simple-linnean-subgroup","genus-authority","species-authority","notes","entry","image","image-credit","image-license","image-caption","taxon-author","taxon-credit","taxon-credit-date","internal-id","source","citation","species-authority-citation","genus-authority-citation"],M={},v=!1,d$("paper-input").removeAttr("invalid");try{q=function(e,a){var t,n,i,r,o,s,l,d,c;if(null==a&&(a=!1),d=a?e:d$(e).val(),o=void 0,1707,r=new Date,s=r.getUTCFullYear()+1,n=/^[1-2][07-9]\d{2}$|^[1-2][07-9]\d{2} (\"|')[1-2][07-9]\d{2}\1$/,isNumber(d)&&1707<d&&d<s||(n.test(d)?-1===d.search(" ")?o="This must be a valid year between 1707 and "+s:(1707<(l=(c=d.split(" "))[0])&&l<s||(o="The first year must be a valid year between 1707 and "+s),1707<(t=c[1].replace(/(\"|')/g,""))&&t<s||(o="The second year must be a valid year between 1707 and "+s),d=d.replace(/'/g,'"')):o=-1===d.search(" ")?"This must be a valid year between 1707 and "+s:"Nonstandard years must be of the form: YYYY 'YYYY', eg, 1801 '1802'"),null!=o){if(v=!0,i=e+" failed its validity checks for `"+d+"`!",console.warn(i),a)throw Error(o);d$(""+e).attr("error-message",o).attr("invalid","invalid")}return d};try{w=q("#edit-gauthyear"),U=q("#edit-sauthyear"),console.log("Escape Completion State:",v)}catch(e){h=e,console.error("Unable to parse authority year! "+h.message),n=""}(t={})[w]=U,n=JSON.stringify(t)}catch(e){h=e,console.error("Failed to JSON parse the authority year - "+h.message),n=""}M.authority_year=n;try{if(c={},p=d$("#edit-deprecated-scientific").val(),isNull(p))m="";else{for(P=0,L=(u=p.split('","')).length;P<L;P++)c[(T=(C=u[P]).split('":"'))[0].replace(/"/g,"")]=T[1].replace(/"/g,"");console.log("Validating",c);for(J in c){if(i=c[J],r=i.split(":"),console.log("Testing "+i,r),2!==r.length)throw Error("Authority string should have an authority and year seperated by a colon.");if(t=r[0].trim(),-1!==(G=r[1].trim()).search(","))throw Error("Looks like there may be an extra space, or forgotten \", near '"+G+"' ");X=q(G,!0),console.log("Validated",t,X)}if((m=JSON.stringify(c)).replace(/[{}]/g,"")!==p)throw Error("Badly formatted entry - generated doesn't match read")}}catch(e){h=e,console.error("Failed to parse the deprecated scientifics - "+h.message+". They may be empty."),m="",f=h.message+". Check your formatting!",d$("#edit-deprecated-scientific").attr("error-message",f).attr("invalid",!0),v=!0,l="There was a problem with your formatting for the deprecated scientifics. Please check it and try again."}M.deprecated_scientific=m,S=["notes","entry","taxon_credit","image","image_credit","image_license","image_caption","species-authority-citation","species_authority_citation","genus-authority-citation","genus_authority_citation","citation"],j=["genus","species","major-type","linnean-order","genus-authority","species-authority"],isNull(d$("#edit-image").val())||(j.push("image-credit"),j.push("image-license")),isNull(d$("#edit-taxon-credit").val())||j.push("taxon-credit-date");for(C in y)if("string"==typeof(_=y[C])){console.log(C,_);try{o=_.replace(/-/g,"_")}catch(e){console.warn("Unable to test against id '"+_+"'");continue}z="#edit-"+o.replace(/\_/gim,"-"),s=!1;try{g=z,"paper-dropdown-menu"===$(g).get(0).tagName.toLowerCase()&&(s=!0)}catch(e){}if(console.debug("Col editor exists for '"+g+"'?",s),s)W=$(g).polymerSelected();else if("image_license"===o)V={},N=$("#edit-image-license").attr("data-license-name"),D=$("#edit-image-license").attr("data-license-url"),V[N]=D,W=JSON.stringify(V);else{k=!1;try{"iron-autogrow-textarea"===$("#edit-"+_).get(0).tagName.toLowerCase()&&(k=!0)}catch(e){}if(k){W=p$("#edit-"+_).value,isNull(W)&&(W=$(p$("#edit-"+_).textarea).val());try{W=W.trim()}catch(e){}}else try{W=d$("#edit-"+_).val().trim()}catch(e){h=e,W="",b="Unable to get value for "+_,console.warn(b+": "+h.message),toastStatusMessage(b)}}if(indexOf.call(S,o)<0)try{isNumber(W)&&(W===""+toInt(W)?W=toInt(W):vale===""+toFloat(W)&&(W=toFloat(W))),W=W.toLowerCase()}catch(e){h=e,console.warn("Column '"+o+"' threw error for value '"+W+"': "+h.message),isNull(W)&&(W="")}switch(_){case"genus":case"species":case"subspecies":f="This required field must have only letters",I=("genus"===_||"species"===_)&&isNull(W),(/[^A-Za-z]/m.test(W)||I)&&(d$("#edit-"+_).attr("error-message",f).attr("invalid","invalid"),v=!0,l="Invalid Scientific Name");break;case"major-type":case"linnean-order":case"genus-authority":case"species-authority":f="This cannot be empty",isNull(W)&&($("#edit-"+_).attr("error-message",f).attr("invalid","invalid"),v=!0,l="Missing Field");break;default:indexOf.call(j,_)>=0&&(B="This must not be empty","#edit-image-credit"!==(Y="#edit-"+_)&&"#edit-image-license"!==Y||(B="This cannot be empty if an image is provided"),"#edit-taxon-credit-date"===Y&&("Invalid Date"===(A=new Date(W))?(B="We couldn't understand your date format. Please try again.",W=null):(W=A.toISOString().split("T")[0],$(Y).attr("value",W),B="If you have a taxon credit, it also needs a date")),isNull(W)&&(d$("#edit-"+_).attr("error-message",B).attr("invalid","invalid"),v=!0,l="REQUIRED_FIELD_EMPTY"))}M[o]=W}return M.id=toInt(d$("#taxon-id").val()),M.parens_auth_genus=d$("#genus-authority-parens").polymerChecked(),M.parens_auth_species=d$("#species-authority-parens").polymerChecked(),M.canonical_sciname=isNull(M.subspecies)?M.genus.toTitleCase()+" "+M.species:M.genus.toTitleCase()+" "+M.species+" "+M.subspecies,v?(animateLoad(),d=null!=l?l:"Bad characters in entry. Stopping ...",l="There was a problem with your entry. Please correct your entry and try again. "+l,stopLoadError(l),console.error(d),console.warn("Save object so far:",M),!0):"save"!==e||isNumber(M.id)?(F=JSON.stringify(M),O=Base64.encodeURI(F),isNull(F)||isNull(O)?(animateLoad(),stopLoadError("The system was unable to parse this entry for the server. Please see the console for more details."),console.error("Unable to stringify the JSON!."),console.warn("The total save object so far is:",M),console.warn("Got the output string",saveSring),console.warn("Sending b64 string",O),!0):(x=$.cookie(uri.domain+"_auth"),R=$.cookie(uri.domain+"_secret"),E=$.cookie(uri.domain+"_link"),H="hash="+x+"&secret="+R+"&dblink="+E,a="perform="+e+"&"+H+"&data="+O,console.log("Going to save",M),console.log("Using mode '"+e+"'"),animateLoad(),$.post(adminParams.apiTarget,a,"json").done(function(e){return!0===e.status?(console.log("Server returned",e),v?(stopLoadError("Warning! The item saved, even though it wasn't supposed to."),!1):(d$("#modal-taxon-edit").get(0).close(),isNull($("#admin-search").val())||renderAdminSearchResults(),prefetchEditorDropdowns(),stopLoad(),delay(250,function(){return stopLoad()}),console.log("Save complete"),!1)):(stopLoadError(e.human_error),console.error(e.error),console.warn("Server returned",e),console.warn("We sent",""+uri.urlString+adminParams.apiTarget+"?"+a),!1)}).fail(function(e,t){return stopLoadError("Failed to send the data to the server."),console.error("Server error! We sent",""+uri.urlString+adminParams.apiTarget+"?"+a),!1}))):(animateLoad(),stopLoadError("The system was unable to generate a valid taxon ID for this entry. Please see the console for more details."),console.error("Unable to get a valid, numeric taxon id! We got '"+M.id+"'."),console.warn("The total save object so far is:",M),!1)},deleteTaxon=function(e){var a,t,n,i,r,o;return t=$(".delete-taxon .delete-taxon-button[data-database-id='"+e+"']"),o=t.attr("data-taxon").replace(/\+/g," "),r=o.substr(0,1).toUpperCase()+o.substr(1),t.hasClass("extreme-danger")?null!=window.deleteWatchTimer?(n=Date.now()-window.deleteWatchTimer,console.warn("The taxon was asked to be deleted "+n+"ms after the confirmation was prompted. Rejecting ..."),!1):(animateLoad(),a="perform=delete&id="+e,$.post(adminParams.apiTarget,a,"json").done(function(n){if(console.log("Filed delete",adminParams.apiTarget+"?"+a),console.log("Server response",n),!0===n.status){t.parents("tr").remove();try{p$("#search-status").hide()}catch(e){}window._metaStatus.isToasting=!1,delay(250,function(){return toastStatusMessage(r+" with ID "+e+" has been removed from the database.")}),stopLoad()}else stopLoadError(n.human_error),console.error(n.error),console.warn(n);return!1}).fail(function(e,a){return stopLoadError("Failed to communicate with the server."),!1})):(window.deleteWatchTimer=Date.now(),delay(300,function(){return delete window.deleteWatchTimer}),t.addClass("extreme-danger").attr("icon","icons:delete-sweep"),i=7500,delay(i,function(){return t.removeClass("extreme-danger").attr("icon","icons:delete-forever")}),toastStatusMessage("Click again to confirm deletion of "+r+". This can't be undone.","",i),!1)},handleDragDropImage=function(e,a){return null==e&&(e="#upload-image"),"function"!=typeof a&&(a=function(e,a){var t,n,i,r;if(!0!==a.status)return null==a.human_error&&(a.human_error="There was a problem uploading your image."),toastStatusMessage(a.human_error),console.error("Error uploading!",a),!1;try{i=e.name,_asm.dropzone.disable(),n=i.split(".").pop(),r="species_photos/"+(md5(i)+"."+n),d$("#edit-image").attr("disabled","disabled").attr("value",r),toastStatusMessage("Upload complete")}catch(e){t=e,console.error("There was a problem with upload post-processing - "+t.message),console.warn("Using",i,a),toastStatusMessage("Your upload completed, but we couldn't post-process it.")}return!1}),loadJS("bower_components/JavaScript-MD5/js/md5.min.js"),loadJS("bower_components/dropzone/dist/min/dropzone.min.js",function(){var t,n,i,r,o;return(t=document.createElement("link")).setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href","css/dropzone.min.css"),document.getElementsByTagName("head")[0].appendChild(t),Dropzone.autoDiscover=!1,n="Drop a high-resolution image for the taxon here.",i=function(){return d$(e).css("box-shadow","").css("border",""),d$(e+" .dz-message span").text(n)},r={url:uri.urlString+"meta.php?do=upload_image",acceptedFiles:"image/*",autoProcessQueue:!0,maxFiles:1,dictDefaultMessage:n,init:function(){return this.on("error",function(){return toastStatusMessage("An error occured sending your image to the server.")}),this.on("canceled",function(){return toastStatusMessage("Upload canceled.")}),this.on("dragover",function(){return d$(e+" .dz-message span").text("Drop here to upload the image"),d$(e).css("box-shadow","0px 0px 15px rgba(15,157,88,.8)").css("border","1px solid #0F9D58")}),this.on("dragleave",function(){return i()}),this.on("dragend",function(){return i()}),this.on("drop",function(){return i()}),this.on("success",function(e,t){return a(e,t)})}},d$(e).hasClass("dropzone")||d$(e).addClass("dropzone"),o=new Dropzone(d$(e).get(0),r),_asm.dropzone=o}),!1},adminPreloadSearch=function(){var e,a,t,n,i,r,o,s;if(!0===_asm.preloaderBlocked)return console.debug("Skipping re-running active search preload"),!1;console.debug("Preloader firing"),_asm.preloaderBlocked=!0,o=Date.now();try{uri.query=decodeURIComponent($.url().attr("fragment"))}catch(e){}if("#"===uri.query||isNull(uri.query))return!1;try{r=Base64.decode(uri.query),r=JSON.parse(r)}catch(e){}if("object"==typeof r){if(isNull(r.genus)||null==r.species)return console.error("Bad taxon format"),!1;for(i in r)s=r[i],e=(e=decodeURIComponent(s)).replace(/(\+|\%20|\s)+/g," "),r[i]=e.trim();a=r.genus+" "+r.species,isNull(r.subspecies)||(a+=" "+r.subspecies),t=1e4,(n=function(){var e,i;try{i=p$("#admin-search").isAttached}catch(e){i=!1}if(("undefined"!=typeof _asm&&null!==_asm?_asm.polymerReady:void 0)&&i){try{p$("#admin-search").value=a}catch(e){$("#admin-search").val(a)}return renderAdminSearchResults(r),e=Date.now()-o,console.log("Search preload finished in "+e+"ms"),_asm.preloaderBlocked=!1}return e=Date.now()-o,console.debug("NOT READY: Duration @ "+e+"ms","undefined"!=typeof _asm&&null!==_asm?_asm.polymerReady:void 0,i,_asm.polymerReady&&i),e>t?(console.error("Timeout waiting for polymerReady!! Not filling search."),_asm.preloaderBlocked=!1,!1):delay(100,function(){return n()})})()}else console.error("Bad fragment: unable to read JSON",r);return!1},$(function(){var e,a;try{a=uri.o.attr("source"),e=/^https?:\/\/(?:.*?\/)+(admin-.*\.(?:php|html)|admin\/)(?:\?(?:&?[\w\-_]+=[\w+\-_%]+)+)?(?:\#[\w\+%]+)?$/im.test(a)}catch(a){e=!0}if($("#next").exists()&&$("#next").unbind().click(function(){return openTab(adminParams.adminPageUrl)}),loadJS("bower_components/bootstrap/dist/js/bootstrap.min.js",function(){return $("[data-toggle='tooltip']").tooltip()}),!e)return console.debug("Not an admin page");try{prefetchEditorDropdowns()}catch(e){}try{return adminPreloadSearch()}catch(e){}});
//# sourceMappingURL=admin.min.js.map