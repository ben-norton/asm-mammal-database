var downloadCSVList,downloadHTMLList,showDownloadChooser,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},modulo=function(a,b){return(+a%(b=+b)+b)%b};downloadCSVList=function(){var a,b,c,d,e,f;return animateLoad(),b="q=*",c=new Date,a=c.getMonth()+1,f=1===(""+a).length?"0"+a:a,e=1===(""+c.getDate()).length?"0"+c.getDate():c.getDate(),d=c.getUTCFullYear()+"-"+f+"-"+e,$.get(""+searchParams.apiPath,b,"json").done(function(a){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;try{if(!0!==a.status)throw Error("Invalid Result");h="      ",i=[],w=["genus","species","subspecies","common_name","image","image_credit","image_license","major_type","major_common_type","major_subtype","minor_type","linnean_order","genus_authority","species_authority","deprecated_scientific","notes","taxon_credit","taxon_credit_date"],t=["genus","common_name","taxon_author","major_subtype","linnean_order"],r=0,u=a.result;for(s in u)if(v=u[s],k=[],!isNull(v.genus)){for(l in v)if(m=v[l],e=l.replace(/"/g,'""'),f=m.replace(/"/g,'""').replace(/&#39;/g,"'"),0===r&&indexOf.call(w,e)>=0&&i.push(e.replace(/_/g," ").toTitleCase()),indexOf.call(w,e)>=0){if(/[a-z]+_authority/.test(e))try{c=JSON.parse(v.authority_year),p="",x="";for(s in c)z=c[s],p=s.replace(/"/g,'""').replace(/&#39;/g,"'"),x=z.replace(/"/g,'""').replace(/&#39;/g,"'");switch(e.split("_")[0]){case"genus":y=f.toTitleCase()+" "+p,toInt(v.parens_auth_genus).toBool()&&(y="("+y+")");break;case"species":y=f.toTitleCase()+" "+x,toInt(v.parens_auth_species).toBool()&&(y="("+y+")")}f=y}catch(a){o=a}indexOf.call(t,e)>=0&&(f=f.toTitleCase()),"image"!==e||isNull(f)||(f="http://mammaldiversity.org/cndb/"+f),k.push('"'+f+'"')}r++,j=k.join(","),h+="\n"+j}return g=i.join(",")+"\n"+h,n="data:text/csv;charset=utf-8,"+encodeURIComponent(g),q='<paper-dialog class="download-file" id="download-csv-file" modal>\n  <h2>Your file is ready</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <p>\n      Please note that some special characters in names may be decoded incorrectly by Microsoft Excel. If this is a problem, following the steps in <a href="https://github.com/SSARHERPS/SSAR-species-database/blob/master/meta/excel_unicode_readme.md"  onclick=\'window.open(this.href); return false;\' onkeypress=\'window.open(this.href); return false;\'>this README <iron-icon icon="launch"></iron-icon></a> to force Excel to format it correctly.\n    </p>\n    <p class="text-center">\n      <a href="'+n+'" download="asm-common-names-'+d+'.csv" class="btn btn-default"><iron-icon icon="file-download"></iron-icon> Download Now</a>\n    </p>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#download-csv-file").exists()?$("#download-csv-file").replaceWith(q):$("body").append(q),$("#download-chooser").get(0).close(),safariDialogHelper("#download-csv-file")}catch(c){return o=c,stopLoadError("There was a problem creating the CSV file. Please try again later."),console.error("Exception in downloadCSVList() - "+o.message),console.warn("Got",a,"from",searchParams.apiPath+"?"+b,a.status)}}).fail(function(){return stopLoadError("There was a problem communicating with the server. Please try again later.")}),!1},downloadHTMLList=function(){return startLoad(),$.get(uri.urlString+"css/download-inline-bootstrap.css").done(function(a){var b,c,d,e,f,g,h;return d=new Date,b=d.getMonth()+1,h=1===(""+b).length?"0"+b:b,f=1===(""+d.getDate()).length?"0"+d.getDate():d.getDate(),e=d.getUTCFullYear()+"-"+h+"-"+f,g='<!doctype html>\n<html lang="en">\n  <head>\n    <title>ASM Species Checklist ver. '+e+'</title>\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta charset="UTF-8"/>\n    <meta name="theme-color" content="#445e14"/>\n    <meta name="viewport" content="width=device-width, initial-scale=1" />\n    <link href=\'http://fonts.googleapis.com/css?family=Droid+Serif:400,700,700italic,400italic|Roboto+Slab:400,700\' rel=\'stylesheet\' type=\'text/css\' />\n    <style type="text/css" id="asm-checklist-inline-stylesheet">\n      '+a+'\n    </style>\n  </head>\n  <body>\n    <div class="container-fluid">\n      <article>\n        <h1 class="text-center">ASM Species Checklist ver. '+e+"</h1>",c="q=*&order=linnean_order,linnean_family,genus,species,subspecies",$.get(""+searchParams.apiPath,c,"json").done(function(a){var b,d,f,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;console.debug("Got",a),startLoad(),toastStatusMessage("Please be patient while we create the file for you"),D=a.count;try{if(!0!==a.status)throw Error("Invalid Result");n=[],m=[],o=[],t=a.result;for(r in t){x=t[r];try{0===modulo(r,100)&&(console.log("Parsing row "+r+" of "+D),0===modulo(r,500)&&(startLoad(),toastStatusMessage("Parsing "+r+" of "+D+", please wait")))}catch(a){}if(!isNull(x.genus)&&!isNull(x.species)){try{if("object"!=typeof x.authority_year)try{b=JSON.parse(x.authority_year)}catch(a){B=x.authority_year.split(":"),B.length>1?(F=B[1].slice(B[1].search('"')+1,-2),F=F.replace(/"/g,"'"),B[1]='"'+F+'"}',b=JSON.parse(B.join(":"))):isNumeric(x.authority_year)&&(b[x.authority_year]=x.authority_year)}else b=x.authority_year;l="",A="";for(d in b)E=b[d],l=d.replace(/&#39;/g,"'"),A=E.replace(/&#39;/g,"'");isNull(x.genus_authority)?x.genus_authority=x.species_authority:isNull(x.species_authority)&&(x.species_authority=x.genus_authority),k=x.genus_authority.toTitleCase()+" "+l,toInt(x.parens_auth_genus).toBool()&&(k="("+k+")"),z=x.species_authority.toTitleCase()+" "+A,toInt(x.parens_auth_species).toBool()&&(z="("+z+")")}catch(a){i=a,console.warn("There was a problem parsing the authority information for _"+x.genus+" "+x.species+" "+x.subspecies+"_ - "+i.message),console.warn(i.stack),console.warn("Bad parse for authority year -- tried to fix >>"+x.authority_year+"<<",b,x.authority_year),console.warn("We were working with",b,l,k,A,z)}try{q=markdown.toHTML(x.notes)}catch(a){i=a,console.warn("Unable to parse Markdown for _"+x.genus+" "+x.species+" "+x.subspecies+"_"),q=x.notes}p="",isNull(q)||isNull(x.taxon_credit)||(C="",isNull(x.taxon_credit_date)||(C=", "+x.taxon_credit_date),p='<p class="text-right small text-muted">\n  <cite>\n    '+x.taxon_credit+C+"\n  </cite>\n</p>"),s="",u=x.linnean_order.trim(),indexOf.call(m,u)<0&&(s+='<h2 class="clade-declaration text-capitalize text-center">'+x.linnean_order+"</h2>",m.push(x.linnean_order.trim())),v=x.linnean_family.trim(),indexOf.call(o,v)<0&&(s+='<h3 class="subclade-declaration text-capitalize text-center">'+x.linnean_family+"</h3>",o.push(x.linnean_family.trim())),w=x.genus,indexOf.call(n,w)<0&&(s+='<aside class="genus-declaration lead">\n  <span class="entry-sciname text-capitalize">'+x.genus+'</span>\n  <span class="entry-authority">'+k.unescape()+"</span>\n</aside>",n.push(x.genus)),y=x.genus.slice(0,1)+". ",j='<section class="species-entry">\n  '+s+'\n  <p class="h4 entry-header">\n    <span class="entry-sciname">\n      <span class="text-capitalize">'+y+"</span> "+x.species+" "+x.subspecies+'\n    </span>\n    <span class="entry-authority">\n      '+z.unescape()+'\n    </span>\n    &#8212;\n    <span class="common_name no-cap">\n      '+smartUpperCasing(x.common_name)+'\n    </span>\n  </p>\n  <div class="entry-content">\n    '+q+"\n    "+p+"\n  </div>\n</section>",g+=j}}return g+="</article>\n</div>\n</body>\n</html>",console.log("HTML file prepped"),h="data:text/html;charset=utf-8,"+encodeURIComponent(g),f='<paper-dialog  modal class="download-file" id="download-html-file">\n  <h2>Your file is ready</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <p class="text-center">\n      <a href="'+h+'" download="asm-species-'+e+'.html" class="btn btn-default"><iron-icon icon="file-download"></iron-icon> Download HTML</a>\n    </p>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#download-html-file").exists()?$("#download-html-file").replaceWith(f):$("body").append(f),$("#download-chooser").get(0).close(),$.post(uri.urlString+"pdf/pdfwrapper.php","html="+encodeURIComponent(g),"json").done(function(a){var b,c;return console.debug("PDF result",a),a.status?(c=""+uri.urlString+a.file,console.debug(c),b='<a href="'+c+'" download="asm-species-'+e+'.pdf" class="btn btn-default"><iron-icon icon="file-download"></iron-icon> Download PDF</a>',$("#download-html-file paper-dialog-scrollable p.text-center a").after(b)):console.error("Couldn't make PDF file")}).error(function(a,b){return console.error("Wasn't able to fetch PDF")}).always(function(){return safariDialogHelper("#download-html-file"),stopLoad()})}catch(b){return i=b,stopLoadError("There was a problem creating your file. Please try again later."),console.error("Exception in downloadHTMLList() - "+i.message),console.warn("Got",a,"from",searchParams.apiPath+"?"+c,a.status),console.warn(i.stack)}}).fail(function(){return stopLoadError("There was a problem communicating with the server. Please try again later.")})}).fail(function(){return stopLoadError("Unable to fetch styles for printout"),!1}),!1},showDownloadChooser=function(){var a;return a='<paper-dialog id="download-chooser" modal>\n  <h2>Select Download Type</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <p>\n      Once you select a file type, it will take a moment to prepare your download. Please be patient.\n    </p>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Cancel</paper-button>\n    <paper-button dialog-confirm id="initiate-csv-download">CSV</paper-button>\n    <paper-button dialog-confirm id="initiate-html-download">HTML/PDF</paper-button>\n  </div>\n</paper-dialog>',$("#download-chooser").exists()||$("body").append(a),$("#initiate-csv-download").click(function(){return downloadCSVList()}),$("#initiate-html-download").click(function(){return downloadHTMLList()}),safariDialogHelper("#download-chooser"),!1};
//# sourceMappingURL=download.min.js.map