var downloadCSVList,downloadHTMLList,showDownloadChooser;downloadCSVList=function(e){var a,o,n,t,s,r,i,l,d,c,p,u;null==e&&(e=!1),animateLoad(),u=Date.now(),_asm.progressTracking={estimate:[]};try{p=e?searchParams.lastSearch:"*",isNull(p)&&(p="*")}catch(e){p="*"}try{for(i=0,l=(c=$("#download-chooser .buttons paper-button")).length;i<l;i++)n=c[i],p$(n).disabled=!0}catch(e){}return o="q="+p,t=new Date,a=t.getMonth()+1,d=1===(""+a).length?"0"+a:a,r=1===(""+t.getDate()).length?"0"+t.getDate():t.getDate(),s=t.getUTCFullYear()+"-"+d+"-"+r,$.get(""+searchParams.apiPath,o,"json").done(function(e){var a,n,t;try{if(!0!==e.status)throw Error("Invalid Result");return startLoad(),toastStatusMessage("Please be patient while we create the file for you"),n={action:"render-csv",data:e},t=new Worker("js/serviceWorker.min.js"),console.info("Rendering list off-thread"),t.addEventListener("message",function(e){var a,o,n,t,r,i,l,d,c,p;if(!0!==e.data.status)return console.warn("Got an error!"),l=isNull(e.data.updateUser)?"Failed to create file":e.data.updateUser,stopLoadError(l,void 0,1e4),!1;if(!0!==e.data.done)return isNull(e.data.updateUser)?isNumber(e.data.progress)?($("#download-progress-indicator").exists()||(i='<paper-progress\n  class="transiting"\n  id="download-progress-indicator"\n  value="0"\n  max="1000">\n</paper-progress>\n<p>\n  <span class="bold">Estimated Time Remaining:</span> <span id="estimated-remaining-time">&#8734;</span>s\n</p>',$("#download-chooser .dialog-content .scrollable").append(i)),p$("#download-progress-indicator").value=e.data.progress,p=(c=Date.now()-u)/(toFloat(e.data.progress)/1e3),_asm.progressTracking.estimate.push(p),t=_asm.progressTracking.estimate.mean()-c,$("#estimated-remaining-time").text(toInt(t/1e3))):console.log("Just an update",e.data):(console.log("Toasting: "+e.data.updateUser),toastStatusMessage(e.data.updateUser,1e3)),!1;o=e.data.csv;try{r=o.length/1024/1024}catch(e){r=0}return console.log("Downloadable size: "+r+" MiB"),null===_asm.sqlDumpLocation?(d='<div id="download-sql-summary" class="data-download-button">\n  <paper-spinner active></paper-spinner> Please wait while your SQL creation finishes ...\n</div>',(a=function(){return null===_asm.sqlDumpLocation?delay(250,function(){return a()}):(d=!1===_asm.sqlDumpLocation?'<a href="#" class="btn btn-danger data-download-button" id="download-sql-summary" disabled><iron-icon icon="icons:error"></iron-icon> SQL Creation Failed</a>':'<a href="'+_asm.sqlDumpLocation+'" download="asm-species-'+s+'.sql" class="btn btn-default data-download-button" id="download-sql-summary"><iron-icon icon="icons:file-download"></iron-icon> Download SQL</a>',$("#download-sql-summary").replaceWith(d)),!1})()):d=!1===_asm.sqlDumpLocation?'<a href="#" class="btn btn-danger data-download-button" id="download-sql-summary" disabled><iron-icon icon="icons:error"></iron-icon> SQL Creation Failed</a>':'<a href="'+_asm.sqlDumpLocation+'" download="asm-species-'+s+'.sql" class="btn btn-default data-download-button" id="download-sql-summary"><iron-icon icon="icons:file-download"></iron-icon> Download SQL</a>',i='<paper-dialog class="download-file" id="download-csv-file" modal>\n  <h2>Your files are ready</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <h3>Want to do data analysis?</h3>\n    <p>\n      We have an open API! Read all of our parameters here:\n      <a href="https://github.com/tigerhawkvok/asm-mammal-database/blob/master/README.md#api"  onclick=\'window.open(this.href); return false;\' onkeypress=\'window.open(this.href); return false;\'>README API Documentation <iron-icon icon="launch"></iron-icon></a>\n      <br/><br/>\n      We also have a UI to perform permission-restricted SQL queries on the database. You can launch this by clicking the <iron-icon icon="icons:code"></iron-icon> icon in the footer.\n    </p>\n    <h3>Which file type do I want?</h3>\n    <p>\n      A CSV file is readily opened by consumer-grade programs, such as Microsoft Excel or Google Spreadsheets.\n      It has some transformations done to the raw data to make it more readable.\n      <br/><br/>\n      However, if you wish to replicate the whole database and perform queries, the SQL file is machine-readable,\n      ready for import into a MySQL or MariaDB database by running the <code>source asm-species-'+s+'.sql;</code> in their\n      interactive shell prompts when run from your download directory. This file has not been transformed in any way.\n    </p>\n    <h3>Excel Important Note</h3>\n    <p>\n      Please note that some special characters in names may be decoded incorrectly by Microsoft Excel. If this is a problem, following the steps in <a href="https://github.com/tigerhawkvok/asm-mammal-database/blob/master/meta/excel_unicode_readme.md"  onclick=\'window.open(this.href); return false;\' onkeypress=\'window.open(this.href); return false;\'>this README <iron-icon icon="icons:launch"></iron-icon></a> to force Excel to format it correctly.\n    </p>\n    <p class="text-center">\n      <a href="'+o+'" download="asm-species-'+s+'.csv" class="btn btn-default data-download-button" id="download-csv-summary"><iron-icon icon="icons:file-download"></iron-icon> Download CSV</a>\n      '+d+'\n    </p>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#download-csv-file").exists()?$("#download-csv-file").replaceWith(i):$("body").append(i),p$("#download-chooser").close(),r>=2?(console.debug("Large file size triggering blob creation"),downloadDataUriAsBlob("#download-csv-summary")):console.debug("File size is small enough to use a data-uri"),delay(250,function(){return safariDialogHelper("#download-csv-file")}),stopLoad(),n=Date.now()-u,console.debug("CSV time elapsed: "+n+"ms"),!1}),t.postMessage(n),!1}catch(n){return a=n,stopLoadError("There was a problem creating the CSV file. Please try again later."),console.error("Exception in downloadCSVList ) - "+a.message),console.warn(a.stack),console.warn("Got",e,"from",searchParams.apiPath+"?"+o,e.status)}}).fail(function(){return stopLoadError("There was a problem communicating with the server. Please try again later.")}),_asm.sqlDumpLocation=null,$.get(uri.urlString+"meta.php","action=get_db_dump","json").done(function(e){return!0===e.status?_asm.sqlDumpLocation=e.download_path:_asm.sqlDumpLocation=!1,!1}).fail(function(e,a){return!1}),!1},downloadHTMLList=function(e){var a,o,n,t,s,r;null==e&&(e=!1),startLoad(),r=Date.now(),_asm.progressTracking={estimate:[]};try{s=e?searchParams.lastSearch:"*",isNull(s)&&(s="*")}catch(e){s="*"}try{for(o=0,n=(t=$("#download-chooser .buttons paper-button")).length;o<n;o++)a=t[o],p$(a).disabled=!0}catch(e){}return $.get(uri.urlString+"css/download-inline-bootstrap.css").done(function(e){var a,o,n,t,i,l,d;return n=new Date,a=n.getMonth()+1,d=1===(""+a).length?"0"+a:a,i=1===(""+n.getDate()).length?"0"+n.getDate():n.getDate(),t=n.getUTCFullYear()+"-"+d+"-"+i,l='<!doctype html>\n<html lang="en">\n  <head>\n    <title>ASM Species Checklist ver. '+t+'</title>\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta charset="UTF-8"/>\n    <meta name="theme-color" content="#445e14"/>\n    <meta name="viewport" content="width=device-width, initial-scale=1" />\n    <link href=\'http://fonts.googleapis.com/css?family=Droid+Serif:400,700,700italic,400italic|Roboto+Slab:400,700\' rel=\'stylesheet\' type=\'text/css\' />\n    <style type="text/css" id="asm-checklist-inline-stylesheet">\n      '+e+'\n    </style>\n  </head>\n  <body>\n    <div class="container-fluid">\n      <article>\n        <h1 class="text-center">ASM Species Checklist ver. '+t+"</h1>",o="q="+s+"&order=linnean_order,linnean_family,genus,species,subspecies",$.get(""+searchParams.apiPath,o,"json").done(function(e){var a,o;return startLoad(),toastStatusMessage("Please be patient while we create the file for you"),a={action:"render-html",data:e,htmlHeader:l},o=new Worker("js/serviceWorker.min.js"),console.info("Rendering list off-thread"),o.addEventListener("message",function(e){var a,o,n,s,i,d,c,p,u;if(!0!==e.data.status)return console.warn("Got an error!"),d=isNull(e.data.updateUser)?"Failed to create file":e.data.updateUser,stopLoadError(d,void 0,1e4),!1;if(!0!==e.data.done){if(isNull(e.data.updateUser))if(isNumber(e.data.progress)){$("#download-progress-indicator").exists()||(i='<paper-progress\n  class="transiting"\n  id="download-progress-indicator"\n  value="0"\n  max="1000">\n</paper-progress>\n<p>\n  <span class="bold">Estimated Time Remaining:</span> <span id="estimated-remaining-time">&#8734;</span>s\n</p>',$("#download-chooser .dialog-content .scrollable").append(i));try{p$("#download-progress-indicator").value=e.data.progress}catch(e){}u=(p=Date.now()-r)/(toFloat(e.data.progress)/1e3),_asm.progressTracking.estimate.push(u),n=_asm.progressTracking.estimate.mean()-p,$("#estimated-remaining-time").text(toInt(n/1e3))}else console.log("Just an update",e.data);else console.log("Toasting: "+e.data.updateUser),toastStatusMessage(e.data.updateUser,1e3);return!1}l=e.data.html,o="data:text/html;charset=utf-8,"+encodeURIComponent(l);try{s=o.length/1024/1024}catch(e){s=0}console.log("Downloadable size: "+s+" MiB"),a='<paper-dialog  modal class="download-file" id="download-html-file">\n  <h2>Your file is ready</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <p>\n      Please note that some taxa may have had incomplete data. Please download a CSV or SQL file for the uncombined taxon data.\n    </p>\n    <p class="text-center">\n      <a href="'+o+'" download="asm-species-'+t+'.html" class="btn btn-default data-download-button" id="download-html-summary"><iron-icon icon="icons:file-download"></iron-icon> Download HTML</a>\n      <div id="pdf-download-placeholder" class="data-download-button">\n        <paper-spinner active></paper-spinner> Please wait while your PDF creation finishes ...\n      </div>\n    </p>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#download-html-file").exists()?$("#download-html-file").replaceWith(a):$("body").append(a),$("#download-chooser").on("iron-overlay-closed",function(){return delay(100,function(){return $(this).remove()})});try{p$("#download-chooser").close()}catch(e){}return s>=2?(console.debug("Large file size triggering blob creation"),downloadDataUriAsBlob("#download-html-summary")):console.debug("File size is small enough to use a data-uri"),safariDialogHelper("#download-html-file"),stopLoad(),toastStatusMessage("Please wait while we prepare your PDF file...","",7e3),c='<a href="#" disabled class="btn btn-danger" id="download-pdf-summary"><iron-icon icon="icons:error"></iron-icon> PDF Creation Failed</a>',console.debug("Posting for PDF"),$.post(uri.urlString+"pdf/pdfwrapper.php","html="+encodeURIComponent(l),"json").done(function(e){var a,o;return console.debug("PDF result",e),e.status?(o=""+uri.urlString+e.file,console.debug(o),a='<a href="'+o+'" download="asm-species-'+t+'.pdf" class="btn btn-default data-download-button" id="download-pdf-summary"><iron-icon icon="file-download"></iron-icon> Download PDF</a>',$("#download-html-file #download-html-summary").after(a)):(stopLoadError("Couldn't make PDF file"),$("#download-html-file #download-html-summary").after(c))}).error(function(e,a){return stopLoadError("Wasn't able to fetch PDF"),$("#download-html-file #download-html-summary").after(c)}).always(function(){var e;try{$("#download-html-file #pdf-download-placeholder").remove()}catch(e){}return e=Date.now()-r,console.debug("HTML+PDF time elapsed: "+e+"ms")}),!1}),o.postMessage(a),!1}).fail(function(){return stopLoadError("There was a problem communicating with the server. Please try again later.")})}).fail(function(){return stopLoadError("Unable to fetch styles for printout"),!1}),!1},showDownloadChooser=function(){var e;return e='<paper-dialog id="download-chooser" modal>\n  <h2>Select Download Type</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <p>\n      Once you select a file type, it will take a moment to prepare your download. Please be patient.\n    </p>\n    <div>\n      <paper-toggle-button id="use-search">Use current search results</paper-toggle-button>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Cancel</paper-button>\n    <paper-button id="initiate-csv-download">CSV/SQL</paper-button>\n    <paper-button id="initiate-html-download">HTML/PDF</paper-button>\n  </div>\n</paper-dialog>',$("#download-chooser").exists()||$("body").append(e),$("#initiate-csv-download").click(function(){var e;try{e=p$("#use-search").checked}catch(a){e=!1}try{p$("#use-search").disabled=!0}catch(e){}return downloadCSVList(e)}),$("#initiate-html-download").click(function(){var e;try{e=p$("#use-search").checked}catch(a){e=!1}try{p$("#use-search").disabled=!0}catch(e){}return downloadHTMLList(e)}),$("#download-chooser").on("iron-overlay-closed",function(){return delay(100,function(e){return function(){return $(e).remove()}}(this))}),safariDialogHelper("#download-chooser"),!1};
//# sourceMappingURL=download.min.js.map