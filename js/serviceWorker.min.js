function shuffle(e){for(var t,o,a=e.length;a;t=Math.floor(Math.random()*a),o=e[--a],e[a]=e[t],e[t]=o);return e}var _asm,authorityMatch,authorityTest,byteCount,commalessTest,createCSVFile,createHtmlFile,dateMonthToString,deEscape,decode64,delay,downloadCSVFile,encode64,generateCSVFromResults,getLocation,goTo,isArray,isBlank,isBool,isEmpty,isJson,isNull,isNumber,jsonTo64,locationData,markdown,openLink,openTab,post64,prepURI,progressStepCount,randomInt,randomString,renderDataArray,roundNumber,roundNumberSigfig,smartUpperCasing,toFloat,toInt,toObject,uri,validateAWebTaxon,window,yearMatch,indexOf=[].indexOf||function(e){for(var t=0,o=this.length;t<o;t++)if(t in this&&this[t]===e)return t;return-1},modulo=function(e,t){return(+e%(t=+t)+t)%t};(locationData={}).params={enableHighAccuracy:!0},locationData.last=void 0,isBool=function(e,t){if(null==t&&(t=!1),t)return"boolean"==typeof e;try{return"boolean"==typeof e?!0===e||!1===e:"string"==typeof e?"true"===e.toLowerCase()||"false"===e.toLowerCase():"number"==typeof e&&(1===e||0===e)}catch(e){return e,!1}},isEmpty=function(e){return!e||0===e.length},isBlank=function(e){return!e||/^\s*$/.test(e)},isNull=function(e){try{if((isEmpty(e)||isBlank(e)||null==e)&&!1!==e&&0!==e)return!0}catch(e){return e,!1}return!1},isJson=function(e){if("object"==typeof e&&!isArray(e))return!0;try{return JSON.parse(e),!0}catch(e){return!1}return!1},isArray=function(e){try{return e.slice(0).push("foo"),!0}catch(e){return!1}},isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},toFloat=function(e){return!isNumber(e)||isNull(e)?0:parseFloat(e)},toInt=function(e){var t;return!isNumber(e)||isNull(e)?0:(t=parseFloat(e),parseInt(t))},String.prototype.toAscii=function(){return this.replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g,"'").replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g,'"').replace(/[\u2013\u2014]/g,"-").replace(/[\u2026]/g,"...").replace(/\u02C6/g,"^").replace(/\u2039/g,"").replace(/[\u02DC|\u00A0]/g," ")},String.prototype.toBool=function(){var e;return"true"===(e=(""+this).toLowerCase())||"1"===e},Boolean.prototype.toBool=function(){return""+this=="true"},Number.prototype.toBool=function(){return""+this=="1"},String.prototype.addSlashes=function(){return this.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.containsObject=function(e){try{return"object"==typeof _.find(this,function(t){return _.isEqual(e,t)})}catch(e){return e,console.error("Please load underscore.js before using this."),console.info("https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js")}},Object.toArray=function(e){try{return e.slice(0).push("foo"),e}catch(e){}return Object.keys(e).map(function(t){return function(t){return e[t]}}())},Object.size=function(e){var t,o,a;if("object"!=typeof e)try{return e.length}catch(e){t=e,console.error("Passed argument isn't an object and doesn't have a .length parameter"),console.warn(t.message)}a=0;for(o in e)e.hasOwnProperty(o)&&a++;return a},Object.doOnSortedKeys=function(e,t){var o,a,r,n,s;for(n=[],a=0,r=(s=Object.keys(e).sort()).length;a<r;a++)o=e[s[a]],n.push(t(o));return n},delay=function(e,t){return setTimeout(t,e)},roundNumber=function(e,t){var o;return null==t&&(t=0),o=Math.pow(10,t),Math.round(e*o)/o},roundNumberSigfig=function(e,t){var o,a,r,n,s;return null==t&&(t=0),r=""+roundNumber(e,t),1===(o=r.split(".")).length?r+"."+Array(t+1).join("0"):(s=o.pop(),n=o[0]+".",s.length===t?r:(a=t-s.length,s+=Array(a+1).join("0"),""+n+s))},String.prototype.stripHtml=function(e){var t;return null==e&&(e=!1),t=this,e&&(t=t.replace(/<(\w+)(?:[^"'>]|"[^"]*"|'[^']*')*>(?:((?:.)*?))<\/?\1(?:[^"'>]|"[^"]*"|'[^']*')*>/gm,"")),t=t.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),t=t.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,"")},String.prototype.unescape=function(){return deEscape(this)},deEscape=function(e){var t,o,a;for(a=e,t=0;o!==a;){if(0!==t&&(a=o,e=o),e=e.replace(/\&amp;#/gim,"&#"),e=e.replace(/\&amp;/gim,"&"),e=e.replace(/\&quot;/gim,'"'),e=e.replace(/\&quote;/gm,'"'),e=e.replace(/\&#95;/gm,"_"),e=e.replace(/\&#39;/gm,"'"),e=e.replace(/\&#34;/gm,'"'),e=e.replace(/\&#62;/gm,">"),e=e.replace(/\&#60;/gm,"<"),++t>=10){console.warn("deEscape quitting after "+t+" iterations");break}o=e}return decodeURIComponent(e)},jsonTo64=function(e,t){var o,a;null==t&&(t=!0);try{e.slice(0).push("foo"),e=toObject(e)}catch(e){}return a=JSON.stringify(e),o=!0===t?post64(a):encode64(o)},encode64=function(e){try{return Base64.encode(e)}catch(t){return t,console.warn("Bad encode string provided"),e}},decode64=function(e){try{return Base64.decode(e)}catch(t){return t,console.warn("Bad decode string provided"),e}},post64=function(e){var t;return t=encode64(e),encodeURIComponent(t)},byteCount=function(e){return function(e){return encodeURI(e).split(/%..|./).length-1}}(),toObject=function(e){var t,o,a;a={};for(o in e)void 0!==(t=e[o])&&(a[o]=t);return a},String.prototype.toTitleCase=function(){var e,t,o,a,r,n,s,i,l;for(n=this.replace(/([^\W_]+[^\s-]*) */g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}),a=["A","An","The","And","But","Or","For","Nor","As","At","By","For","From","In","Into","Near","Of","On","Onto","To","With"],e=0,21;e<21;e++)t=a[e],o=RegExp("\\s"+t+"\\s","g"),n=n.replace(o,function(e){return e.toLowerCase()});for(l=["Id","Tv"],r=0,2;r<2;r++)s=l[r],i=RegExp("\\b"+s+"\\b","g"),n=n.replace(i,s.toUpperCase());return n},smartUpperCasing=function(e){var t,o,a,r,n,s,i,l,c,u,p;if(isNull(e))return"";n=function(e){return e.replace(e,e.toUpperCase())},c=e.replace(/((?=((?!-)[\W\s\r\n]))\s[A-Za-z]|^[A-Za-z])/g,n),u=["a","an","and","at","but","by","for","in","nor","of","on","or","out","so","to","the","up","yet"];try{for(t=0,o=18;t<o;t++)s=(p=u[t]).toTitleCase(),r=p.toLowerCase(),a=RegExp(" "+s+" ","g"),c=c.replace(a," "+r+" ")}catch(e){}try{c.match(/([a-zA-Z]+ )*[a-zA-Z]+-([a-z]+)( [a-zA-Z]+)*/m)&&(l=(i=c.replace(/([a-zA-Z]+ )*[a-zA-Z]+-([a-z]+)( [a-zA-Z]+)*/gm,"$2")).toTitleCase(),c=c.replace(i,l))}catch(e){}return c},Function.prototype.getName=function(){var e;return null==(e=this.name)&&(e=(""+this).substr(0,(""+this).indexOf("(")).replace("function ","")),isNull(e)&&(e=md5(""+this)),e},randomInt=function(e,t){var o,a,r;return null==e&&(e=0),null==t&&(t=1),r=Math.random(),null==e&&(e=(o=[0,e])[0],t=o[1]),e>t&&(e=(a=[t,e])[0],t=a[1]),Math.floor(r*(t-e+1)+e)},randomString=function(e){var t,o,a;for(null==e&&(e=8),o=0,65,126,a=[];o<e;)++o,t=randomInt(65,126),a.push(String.fromCharCode(t));return a.join("")},openLink=function(e){return null!=e&&(open(e),!1)},openTab=function(e){return openLink(e)},goTo=function(e){return null!=e&&(location.href=e,!1)},dateMonthToString=function(e){var t,o;t={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};try{o=t[e]}catch(t){o=e}return o},prepURI=function(e){return(e=encodeURIComponent(e)).replace(/%20/g,"+")},(locationData={}).params={enableHighAccuracy:!0},locationData.last=void 0,getLocation=function(e){var t,o,a;return null==e&&(e=void 0),1500,o=function(t){var o;return clearTimeout(a),locationData.lat=t.coords.latitude,locationData.lng=t.coords.longitude,locationData.acc=t.coords.accuracy,o=locationData.last,locationData.last=Date.now(),!(locationData.last-o<1500)&&(console.info("Successfully set location"),"function"==typeof e&&e(locationData),!1)},t=function(t){var o;return clearTimeout(a),o=function(){switch(t.code){case 0:return"There was an error while retrieving your location: "+t.message;case 1:return"The user prevented this page from retrieving a location";case 2:return"The browser was unable to determine your location: "+t.message;case 3:return"The browser timed out retrieving your location."}}(),console.error(o),"function"==typeof e&&e(!1),!1},navigator.geolocation?(console.log("Querying location"),navigator.geolocation.getCurrentPosition(o,t,locationData.params),a=delay(1500,function(){return getLocation(e)})):(console.warn("This browser doesn't support geolocation!"),null!=e?e(!1):void 0)},downloadCSVFile=function(e,t){var o,a,r,n,s,i,l,c,u,p,d,h,y,f,g,m,b,_;if(b=Date.now(),_="",isJson(e)&&"string"==typeof e){console.info("Parsing as JSON string");try{p=JSON.parse(e)}catch(t){throw r=t,console.error("COuldn't parse json! "+r.message),console.warn(r.stack),console.info(e),"error"}}else if(isArray(e))console.info("Parsing as array"),p=toObject(e);else{if("object"!=typeof e)return console.error("Unexpected data type '"+typeof e+"' for downloadCSVFile()",e),!1;console.info("Parsing as object"),p=e}for(null==t&&(t={}),null==t.create&&(t.create=!1),null==t.downloadFile&&(t.downloadFile="datalist.csv"),null==t.classes&&(t.classes="btn btn-default"),null==t.buttonText&&(t.buttonText="Download File"),null==t.iconHtml&&(t.iconHtml='<iron-icon icon="icons:cloud-download"></iron-icon>'),null==t.selector&&(t.selector="#download-file"),null==t.splitValues&&(t.splitValues=!1),null==t.cascadeObjects&&(t.cascadeObjects=!1),null==t.objectAsValues&&(t.objectAsValues=!0),l=[],(f=function(o,a){var n,s,i,c,u,p,d,h,y,g,m,b;y=0,t.objectAsValues&&(t.splitValues="::@@::"),h=[];for(u in o)if("function"!=typeof(b=o[u])){++y;try{if(i=(""+u).replace(/"/g,'""'),1===y)if(t.objectAsValues){console.info("objectAsValues set");for(n in b)e=b[n],isArray(t.acceptableCols)?indexOf.call(t.acceptableCols,n)>=0&&l.push(n):l.push(n);console.log("Using as header",l)}else console.log("Boring options",t.objectAsValues,t),l.push(i);if("object"==typeof b&&a&&(b=f(b,!0)),c=function(e,o){var a,r,n;return null==e&&(e=b),null==o&&(o=t),isNull(b)?a="":("object"==typeof e&&(e=JSON.stringify(e)),r=(r=(r=(e=""+e).replace(/,/g,",")).replace(/"/g,'""')).replace(/<\/p><p>/g,'","'),"string"==typeof o.splitValues&&(r=r.split(o.splitValues).join('","'),i=!1),a=r),!1===i?n='"'+a+'"\n':isNumber(i)?n='"'+a+'",':isNull(i)||(n='"'+i+'","'+a+'"\n'),n},t.objectAsValues){for(g=[],p=0,d=l.length;p<d;p++){if(n=l[p],"object"==typeof(s=b[n]))try{s=(s=JSON.stringify(s)).replace(/"/g,'""')}catch(e){}g.push(s)}m=g.join(t.splitValues),h.push(_+=c(m,t))}else h.push(_+=c(b))}catch(e){r=e,console.warn("Unable to run key "+u+" on row "+y,b,o),h.push(console.warn(r.stack))}}return h})(p,t.cascadeObjects),_=_.trim(),d=0,h=0,y=l.length;h<y;h++)a=(a=l[h]).replace(/"/g,'""'),l[d]=a,++d;return t.objectAsValues&&(t.header=l),isArray(t.header)?(c=t.header.join('","'),_=(_='"'+c+'"\n'+_).trim(),i="present"):i="absent",","===_.slice(-1)&&(_=_.slice(0,-1)),s="data:text/csv;charset=utf-8;header="+i+","+encodeURIComponent(_),m=t.selector,!0===t.create?(o=randomInt(0,9999),u='<a id="'+(m.slice(1)+"-download-button-"+o)+'" class="'+t.classes+'" href="'+s+'" download="'+t.downloadFile+'">\n  '+t.iconHtml+"\n  "+t.buttonText+"\n</a>"):u="",g={file:s,options:t,html:u},n=Date.now()-b,console.debug("CSV Worker saved "+n+"ms from main thread"),g},generateCSVFromResults=function(e,t,o){var a,r;null==o&&(o="#modal-sql-details-list"),console.info("Worker CSV: Given",e),a={objectAsValues:!0,downloadFile:"adp-global-search-result-data_"+Date.now()+".csv"};try{r=downloadCSVFile(e,a)}catch(e){console.error("Sorry, there was a problem with this dataset and we can't do that right now."),r={file:"",options:a,html:""}}return r},validateAWebTaxon=function(e,t){var o,a,r;return null==t&&(t=null),null==(void 0!==r&&null!==r?r.validatedTaxons:void 0)&&("object"!=typeof r&&(r={}),r.validatedTaxons=[]),a=function(e){return"function"==typeof t&&t(e),!1},r.validatedTaxons.containsObject(e)?(console.info("Already validated taxon, skipping revalidation",e),a(e),!1):(o="action=validate&genus="+e.genus+"&species="+e.species,null!=e.subspecies&&(o+="&subspecies="+e.subspecies),_adp.currentAsyncJqxhr=$.post("api.php",o,"json").done(function(t){return t.status?(e.genus=t.validated_taxon.genus,e.species=t.validated_taxon.species,e.subspecies=t.validated_taxon.subspecies,null==e.clade&&(e.clade=t.validated_taxon.family),r.validatedTaxons.push(e)):e.invalid=!0,e.response=t,a(e),!1}).fail(function(t,o){var a;return a=e.genus+" "+e.species,a=null!=e.subspecies?a+" "+e.subspecies:a,bsAlert("<strong>Problem validating taxon:</strong> "+a+" couldn't be validated."),console.warn("Warning: Couldn't validated "+a+" with AmphibiaWeb")}),!1)},authorityTest=/^\(? *((['"]?) *(?:(?:\b|[\u00C0-\u017F])[a-z\u00C0-\u017F\u2019 \.\-\[\]\?]+(?:,|,? *&|,? *&amp;| *&amp;amp;| *&(?:[a-z]+|#[0-9]+);)? *)+ *\2) *, *([0-9]{4}) *\)?/gim,yearMatch="$3",authorityMatch="$1",commalessTest=/^(\(?)(.*?[^,]) ([0-9]{4})(\)?)$/gim,progressStepCount=1e3,"object"!=typeof uri&&(uri={urlString:""}),"object"!=typeof _asm&&(_asm={affiliateQueryUrl:{iucnRedlist:"http://apiv3.iucnredlist.org/api/v3/species/common_names/"}}),self.addEventListener("message",function(e){var t,o,a,r;switch(e.data.action){case"render-row":return o=e.data.data,t=isNumber(e.data.chunk)?toInt(e.data.chunk):100,a=null!=(r=e.data.firstIteration.toBool())&&r,renderDataArray(o,a,t);case"render-html":return console.log("Got HTML info from file on thread",e.data),createHtmlFile(e.data.data,e.data.htmlHeader);case"render-csv":return console.log("Got CSV info from file on thread",e.data),createCSVFile(e.data.data);default:return console.error("No valid action recieved from worker initialization!",e.data),console.warn(e)}}),window={},self.importScripts("markdown.min.js"),self.importScripts("markdown.min.js"),markdown=window.markdown,renderDataArray=function(e,t,o){var a,r,n,s,i,l,c,u,p,d,h,y,f,g,m,b,_,w,v,N,j,x,C;for(null==e&&(e=dataArray),null==t&&(t=!0),null==o&&(o=100),u="",[],"cndb-result-list",p="<table id='cndb-result-list' class='table table-striped table-hover col-md-12'>\n\t<tr class='cndb-row-headers'>","</table>",a=0,isNumber(o)||(o=100),l=e.length<=o,h=0,console.log("Starting loop with i = "+h+", renderChunk = "+o+", data length = "+e.length,t,l),m=0,b=e.length;m<b;m++){if(v=e[m],h,0===toInt(h)&&t){y=0,p+="\n\x3c!-- Table Headers - "+Object.size(v)+" entries --\x3e";for(f in v)v[f],w=f.replace(/_/g," "),p+="\n\t\t<th class='text-center'>"+(w=function(){switch(w){case"simple linnean subgroup":return"Group";case"major subtype":return"Clade";default:return w}}())+"</th>",a++,y++;p+="\n\t</tr>",p+="\n\x3c!-- End Table Headers --\x3e",console.log("Got "+a+" display columns."),n="col-md-"+roundNumber(12/a,0),u=p}x=v.genus+"+"+v.species,isNull(v.subspecies)||(x=x+"+"+v.subspecies),d="\n\t<tr id='"+("msadb-row"+h)+"' class='cndb-result-entry' data-taxon=\""+x+'" data-genus="'+v.genus+'" data-species="'+v.species+'">';for(f in v){if(r=v[f],0===toInt(h)&&t&&console.debug("Sample row",v),"authority_year"===f)if(isNull(r))console.debug("null col",r,f),s=r;else{try{s=JSON.parse(r),isNumber(s)&&(s=JSON.parse('{"Unk.":"'+s+'"}'))}catch(e){i=e;try{console.warn("There was an error parsing authority_year='"+r+"', attempting to fix - ",i.message),j=r.split(":"),C=j[1].slice(j[1].search('"')+1,-2),C=C.replace(/"/g,"'"),j[1]='"'+C+'"}',r=j.join(":"),s=JSON.parse(r)}catch(e){i=e,console.error("There was an error parsing '"+r+"'",i.message),s=r}}try{c=Object.keys(s)[0],N=s[c],toInt(v.parens_auth_genus).toBool()&&(c="("+c+")"),toInt(v.parens_auth_species).toBool()&&(N="("+N+")"),r="G: "+c+"<br/>S: "+N}catch(e){}}"image"===f&&(r=isNull(r)?"<paper-icon-button icon='launch' data-href='"+_asm.affiliateQueryUrl.mammalPhotos+"?rel-taxon=contains&where-taxon="+x+"' class='newwindow calphoto click' data-taxon=\""+x+'"></paper-icon-button>':"<paper-icon-button icon='image:image' data-lightbox='"+uri.urlString+r+"' class='lightboximage'></paper-icon-button>"),g="genus"!==f&&"species"!==f&&"subspecies"!==f?f+" text-center":f,"genus_authority"===f||"species_authority"===f?g+=" authority":"common_name"===f&&(r=smartUpperCasing(r),g+=" no-cap"),d+="\n\t\t<td id='"+f+"-"+h+"' class='"+g+" "+n+"'>"+r+"</td>"}if(d+="\n\t</tr>",u+=d,++h>=o)break}return console.log("Ended data loop with i = "+h+", renderChunk = "+o),t&&(u+="</table>"),_={html:u,nextChunk:e.slice(h),renderChunk:o,loops:h},self.postMessage(_),self.close()},createHtmlFile=function(e,t){var o,a,r,n,s,i,l,c,u,p,d,h,y,f,g,m,b,_,w,v,N,j,x,C,S,T,O,A,k,F;T=Date.now(),console.debug("Got",e),console.debug("Got body provided?",!isNull(t)),m=(A=e.count)/progressStepCount,console.debug("Step size",m);try{if(!0!==e.status)throw Error("Invalid Result");u=[],c=[],p=[],b=e.result;for(y in b){N=b[y];try{y>0&&(0===toInt(modulo(y,m))&&(f={status:!0,done:!1,progress:toInt(y/m)},self.postMessage(f)),0===modulo(y,100)&&0===modulo(y,500)&&(f={status:!0,done:!1,updateUser:"Parsing "+y+" of "+A+", please wait"},self.postMessage(f)))}catch(e){}if(!isNull(N.genus)&&!isNull(N.species)){try{clearTimeout(l),l=delay(250,function(){return console.warn("Possible hang on row #"+y,N),l=delay(1e3,function(){return f={status:!1,done:!1,updateUser:"Failure to parse row "+y},self.postMessage(f),self.close()})})}catch(e){}try{if("object"!=typeof N.authority_year){o={};try{isNumber(N.authority_year)?o[N.authority_year]=N.authority_year:isNull(N.authority_year)?(isJson(N.species_authority)&&(N.species_authority=JSON.stringify(N.species_authority)),N.species_authority=N.species_authority.replace(/(<\/|<|&lt;|&lt;\/).*?(>|&gt;)/gim,""),commalessTest.test(N.species_authority)&&(N.species_authority=N.species_authority.replace(commalessTest,"$1$2, $3$4")),authorityTest.test(N.species_authority)?(F=N.species_authority.replace(authorityTest,yearMatch),N.species_authority=N.species_authority.replace(authorityTest,authorityMatch),o[F]=F,N.authority_year=o):(isNull(N.species_authority)||console.warn("Failed a match on authority '"+N.species_authority+"'"),o.Unknown="Unknown")):o=JSON.parse(N.authority_year)}catch(e){n=e,console.debug("authority isnt number, null, or object, with bad species_authority '"+N.authority_year+"'"),(S=N.authority_year.split(":")).length>1?(F=S[1].slice(S[1].search('"')+1,-2),F=F.replace(/"/g,"'"),S[1]='"'+F+'"}',o=JSON.parse(S.join(":"))):(console.warn("Unable to figure out the type of data for `authority_year`: "+n.message,JSON.stringify(N)),console.warn(n.stack))}}else o=N.authority_year;try{i=Object.keys(o)[0],C=o[i],i=(""+i).replace(/&#39;/g,"'"),C=(""+C).replace(/&#39;/g,"'")}catch(e){for(a in o)k=o[a],i=(""+a).replace(/&#39;/g,"'"),C=(""+k).replace(/&#39;/g,"'")}isNull(N.genus_authority)?N.genus_authority=N.species_authority:isNull(N.species_authority)&&(N.species_authority=N.genus_authority),s=N.genus_authority.toTitleCase()+" "+i,toInt(N.parens_auth_genus).toBool()&&(s="("+s+")"),x=N.species_authority.toTitleCase()+" "+C,toInt(N.parens_auth_species).toBool()&&(x="("+x+")")}catch(e){n=e,console.warn("There was a problem parsing the authority information for _"+N.genus+" "+N.species+" "+N.subspecies+"_ - "+n.message),console.warn(n.stack),console.warn("Bad parse for authority year -- tried to fix >>"+N.authority_year+"<<",o,N.authority_year),console.warn("We were working with",o,i,s,C,x)}if(isNull(N.entry))h="";else try{h=markdown.toHTML(N.entry)}catch(e){n=e,console.warn("Unable to parse Markdown for _"+N.genus+" "+N.species+" "+N.subspecies+"_"),h=N.entry}d="",isNull(h)||isNull(N.taxon_credit)||(O="",isNull(N.taxon_credit_date)||(O=", "+N.taxon_credit_date),d='<p class="text-right small text-muted">\n  <cite>\n    '+N.taxon_credit+O+"\n  </cite>\n</p>"),g="",_=N.linnean_order.trim(),indexOf.call(c,_)<0&&(g+='<h2 class="clade-declaration text-capitalize text-center">'+N.linnean_order+"</h2>",c.push(N.linnean_order.trim())),w=N.linnean_family.trim(),indexOf.call(p,w)<0&&(g+='<h3 class="subclade-declaration text-capitalize text-center">'+N.linnean_family+"</h3>",p.push(N.linnean_family.trim())),v=N.genus,indexOf.call(u,v)<0&&(null==s&&(s=""),g+='<aside class="genus-declaration lead">\n  <span class="entry-sciname text-capitalize">'+N.genus+'</span>\n  <span class="entry-authority">'+(null!=s?s.unescape():void 0)+"</span>\n</aside>",u.push(N.genus)),j=N.genus.slice(0,1)+". ",null==x&&(x=""),t+='<section class="species-entry">\n  '+g+'\n  <p class="h4 entry-header">\n    <span class="entry-sciname">\n      <span class="text-capitalize">'+j+"</span> "+N.species+" "+N.subspecies+'\n    </span>\n    <span class="entry-authority">\n      '+(null!=x?x.unescape():void 0)+'\n    </span>\n    &#8212;\n    <span class="common_name no-cap">\n      '+smartUpperCasing(N.common_name)+'\n    </span>\n  </p>\n  <div class="entry-content">\n    '+h+"\n    "+d+"\n  </div>\n</section>"}}return t+="</article>\n</div>\n</body>\n</html>",f={status:!0,done:!1,progress:progressStepCount},self.postMessage(f),r=Date.now()-T,console.log("HTML file prepped in "+r+"ms off-thread"),f={html:t,status:!0,done:!0},self.postMessage(f),console.debug("Completed worker!"),self.close()}catch(e){return n=e,console.error("There was a problem creating your file. Please try again later."),console.error("Exception in createHtmlFile() - "+n.message),console.warn(n.stack),f={status:!1,done:!0},self.postMessage(f),self.close()}},createCSVFile=function(e){var t,o,a,r,n,s,i,l,c,u,p,d,h,y,f,g,m,b,_,w,v,N,j,x,C,S,T,O,A,k,F,M;O=Date.now(),i="  ",l=[],C=["genus","species","subspecies","canonical_sciname","common_name","common_name_source","image","image_caption","image_credit","image_license","major_type","major_subtype","simple_linnean_group","simple_linnean_subgroup","linnean_order","linnean_family","genus_authority","species_authority","deprecated_scientific","notes","entry","taxon_credit","taxon_credit_date","taxon_author","citation","source","internal_id"],w=["genus","common_name","taxon_credit","linnean_order","linnean_family","genus_authority","species_authority"],o=["parens_auth_genus","parens_auth_species"],g=0,console.debug("Got result"),N=(k=Object.size(e.result))/progressStepCount,console.debug("Step size",N);try{j=e.result;for(m in j)if(x=j[m],m>0&&(0===toInt(modulo(m,N))&&(v={status:!0,done:!1,progress:toInt(m/N)},self.postMessage(v)),0===modulo(m,100)&&(console.debug("CSV-ing row "+m+" of "+k),0===modulo(m,500)&&(v={status:!0,done:!1,updateUser:"Parsing "+m+" of "+k+", please wait"},self.postMessage(v)))),c=[],!isNull(x.genus)&&!isNull(x.species)){for(b=0,_=C.length;b<_;b++){p=x[u=C[b]],r=u.replace(/"/g,'""');try{n=p.replace(/"/g,'""').replace(/&#39;/g,"'")}catch(e){n=""}if(0===g&&indexOf.call(C,r)>=0&&l.push(r.replace(/_/g," ").toTitleCase()),indexOf.call(C,r)>=0){if(/[a-z]+_authority/.test(r)){n=n.unescape();try{if("object"!=typeof x.authority_year){t={};try{isNumber(x.authority_year)?t[x.authority_year]=x.authority_year:isNull(x.authority_year)?(x.species_authority=x.species_authority.replace(/(<\/|<|&lt;|&lt;\/).*?(>|&gt;)/gim,""),commalessTest.test(x.species_authority)&&(x.species_authority=x.species_authority.replace(commalessTest,"$1$2, $3$4")),authorityTest.test(x.species_authority)?(M=x.species_authority.replace(authorityTest,yearMatch),x.species_authority=x.species_authority.replace(authorityTest,authorityMatch),t[M]=M,x.authority_year=t):(isNull(x.species_authority)||console.warn("Failed a match on authority '"+x.species_authority+"'"),t.Unknown="Unknown")):t=JSON.parse(x.authority_year)}catch(e){y=e,console.debug("authority isnt number, null, or object, with bad species_authority '"+x.authority_year+"'"),(T=x.authority_year.split(":")).length>1?(M=T[1].slice(T[1].search('"')+1,-2),M=M.replace(/"/g,"'"),T[1]='"'+M+'"}',t=JSON.parse(T.join(":"))):(console.warn("Unable to figure out the type of data for `authority_year`: "+y.message,JSON.stringify(x)),console.warn(y.stack))}}else t=x.authority_year;"string"==typeof x.authority_year&&(x.authority_year=x.authority_year.trim()),isNull(x.authority_year)&&(x.authority_year=JSON.stringify(t));try{f=Object.keys(t)[0],S=t[f],f=f.replace(/&#39;/g,"'"),S=S.replace(/&#39;/g,"'")}catch(e){for(a in t)F=t[a],f=a.replace(/&#39;/g,"'"),S=F.replace(/&#39;/g,"'")}if(isNull(x.genus_authority)?x.genus_authority=x.species_authority+" [assumed]":isNull(x.species_authority)&&(x.species_authority=x.genus_authority),isNull(n)){try{n=x[u].unescape()}catch(e){}(isNull(n)||"[assumed]"===n.trim())&&(n="Unknown")}switch(r.split("_")[0]){case"genus":A=n.toTitleCase()+", "+f,toInt(x.parens_auth_genus).toBool()&&(A="("+A+")");break;case"species":A=n.toTitleCase()+", "+S,toInt(x.parens_auth_species).toBool()&&(A="("+A+")")}n=A}catch(e){y=e}}if("authority_year"===u)if(isNull(n&&!isNull(x[u])))try{"object"==typeof(n=x[u])&&(n=JSON.stringify(n).replace(/"/g,'""'))}catch(e){}else console.debug("auth year '"+n+"' is valid",isNull(n,!isNull(x[u],r,u)));if("deprecated_scientific"===u&&"object"==typeof n&&(n=JSON.stringify(n)),indexOf.call(w,r)>=0&&(n=n.toTitleCase()),"image"!==r||isNull(n)||(n=""+uri.urlString+n),indexOf.call(o,r)>=0)try{n=""+n.toBool()}catch(e){}c.push('"'+n+'"')}}g++,i+="\n"+c.join(",")}return s=l.join(",")+"\n"+i,d="data:text/csv;charset=utf-8,"+encodeURIComponent(s),v={status:!0,done:!1,progress:progressStepCount},self.postMessage(v),h=Date.now()-O,console.log("CSV file prepped in "+h+"ms off-thread"),v={csv:d,status:!0,done:!0},self.postMessage(v),console.debug("Completed worker!"),self.close()}catch(e){return y=e,console.error("There was a problem creating your file. Please try again later."),console.error("Exception in createCSVFile() - "+y.message),console.warn(y.stack),v={status:!1,done:!0},self.postMessage(v),self.close()}};
//# sourceMappingURL=serviceWorker.min.js.map