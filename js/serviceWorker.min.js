var _asm,authorityMatch,authorityTest,byteCount,commalessTest,createCSVFile,createHtmlFile,dateMonthToString,deEscape,decode64,delay,downloadCSVFile,encode64,generateCSVFromResults,getLocation,goTo,isArray,isBlank,isBool,isEmpty,isJson,isNull,isNumber,jsonTo64,locationData,markdown,openLink,openTab,post64,prepURI,progressStepCount,randomInt,randomString,renderDataArray,roundNumber,roundNumberSigfig,smartUpperCasing,toFloat,toInt,toObject,uri,validateAWebTaxon,window,yearMatch,indexOf=[].indexOf||function(e){for(var t=0,o=this.length;t<o;t++)if(t in this&&this[t]===e)return t;return-1},modulo=function(e,t){return(+e%(t=+t)+t)%t};function shuffle(e){for(var t,o,r=e.length;r;t=Math.floor(Math.random()*r),o=e[--r],e[r]=e[t],e[t]=o);return e}(locationData={}).params={enableHighAccuracy:!0},locationData.last=void 0,isBool=function(e,t){if(null==t&&(t=!1),t)return"boolean"==typeof e;try{return"boolean"==typeof e?!0===e||!1===e:"string"==typeof e?"true"===e.toLowerCase()||"false"===e.toLowerCase():"number"==typeof e&&(1===e||0===e)}catch(e){return e,!1}},isEmpty=function(e){return!e||0===e.length},isBlank=function(e){return!e||/^\s*$/.test(e)},isNull=function(e){try{if((isEmpty(e)||isBlank(e)||null==e)&&!1!==e&&0!==e)return!0}catch(e){return e,!1}return!1},isJson=function(e){if("object"==typeof e&&!isArray(e))return!0;try{return JSON.parse(e),!0}catch(e){return!1}return!1},isArray=function(e){try{return e.slice(0).push("foo"),!0}catch(e){return!1}},isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},toFloat=function(e){return!isNumber(e)||isNull(e)?0:parseFloat(e)},toInt=function(e){return!isNumber(e)||isNull(e)?0:parseInt(parseFloat(e))},String.prototype.toAscii=function(){return this.replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g,"'").replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g,'"').replace(/[\u2013\u2014]/g,"-").replace(/[\u2026]/g,"...").replace(/\u02C6/g,"^").replace(/\u2039/g,"").replace(/[\u02DC|\u00A0]/g," ")},String.prototype.toBool=function(){var e;return"true"===(e=this.toString().toLowerCase())||"1"===e},Boolean.prototype.toBool=function(){return"true"===this.toString()},Number.prototype.toBool=function(){return"1"===this.toString()},String.prototype.addSlashes=function(){return this.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.containsObject=function(e){try{return"object"==typeof _.find(this,function(t){return _.isEqual(e,t)})}catch(e){return e,console.error("Please load underscore.js before using this."),console.info("https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js")}},Object.toArray=function(e){try{return e.slice(0).push("foo"),e}catch(e){}return Object.keys(e).map(function(t){return e[t]})},Object.size=function(e){var t,o,r;if("object"!=typeof e)try{return e.length}catch(e){t=e,console.error("Passed argument isn't an object and doesn't have a .length parameter"),console.warn(t.message)}for(o in r=0,e)e.hasOwnProperty(o)&&r++;return r},Object.doOnSortedKeys=function(e,t){var o,r,a,n,s;for(n=[],r=0,a=(s=Object.keys(e).sort()).length;r<a;r++)o=e[s[r]],n.push(t(o));return n},delay=function(e,t){return setTimeout(t,e)},roundNumber=function(e,t){var o;return null==t&&(t=0),Math.round(e*(o=Math.pow(10,t)))/o},roundNumberSigfig=function(e,t){var o,r,a,n,s;return null==t&&(t=0),1===(o=(a=roundNumber(e,t).toString()).split(".")).length?a+"."+Array(t+1).join("0"):(s=o.pop(),n=o[0]+".",s.length===t?a:(r=t-s.length,""+n+(s+=Array(r+1).join("0"))))},String.prototype.stripHtml=function(e){var t;return null==e&&(e=!1),t=this,e&&(t=t.replace(/<(\w+)(?:[^"'>]|"[^"]*"|'[^']*')*>(?:((?:.)*?))<\/?\1(?:[^"'>]|"[^"]*"|'[^']*')*>/gm,"")),t=(t=t.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,"")).replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,"")},String.prototype.unescape=function(){return deEscape(this)},deEscape=function(e){var t,o,r;for(r=e,t=0;o!==r;){if(0!==t&&(r=o,e=o),e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\&amp;#/gim,"&#")).replace(/\&amp;/gim,"&")).replace(/\&quot;/gim,'"')).replace(/\&quote;/gm,'"')).replace(/\&#95;/gm,"_")).replace(/\&#39;/gm,"'")).replace(/\&#34;/gm,'"')).replace(/\&#62;/gm,">")).replace(/\&#60;/gm,"<"),++t>=10){console.warn("deEscape quitting after "+t+" iterations");break}o=e}return decodeURIComponent(e)},jsonTo64=function(e,t){var o,r;null==t&&(t=!0);try{e.slice(0).push("foo"),e=toObject(e)}catch(e){}return r=JSON.stringify(e),o=!0===t?post64(r):encode64(o)},encode64=function(e){try{return Base64.encode(e)}catch(t){return t,console.warn("Bad encode string provided"),e}},decode64=function(e){try{return Base64.decode(e)}catch(t){return t,console.warn("Bad decode string provided"),e}},post64=function(e){var t;return t=encode64(e),encodeURIComponent(t)},byteCount=function(e){return encodeURI(e).split(/%..|./).length-1},toObject=function(e){var t,o,r;for(o in r={},e)void 0!==(t=e[o])&&(r[o]=t);return r},String.prototype.toTitleCase=function(){var e,t,o,r,a,n,s,i,l,c;for(s=this.replace(/([^\W_]+[^\s-]*) */g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}),e=0,t=(a=["A","An","The","And","But","Or","For","Nor","As","At","By","For","From","In","Into","Near","Of","On","Onto","To","With"]).length;e<t;e++)r=RegExp("\\s"+a[e]+"\\s","g"),s=s.replace(r,function(e){return e.toLowerCase()});for(n=0,o=(c=["Id","Tv"]).length;n<o;n++)l=RegExp("\\b"+(i=c[n])+"\\b","g"),s=s.replace(l,i.toUpperCase());return s},smartUpperCasing=function(e){var t,o,r,a,n,s,i,l,c,u,p;if(isNull(e))return"";n=function(e){return e.replace(e,e.toUpperCase())},c=e.replace(/((?=((?!-)[\W\s\r\n]))\s[A-Za-z]|^[A-Za-z])/g,n),u=["a","an","and","at","but","by","for","in","nor","of","on","or","out","so","to","the","up","yet"];try{for(t=0,o=u.length;t<o;t++)s=(p=u[t]).toTitleCase(),a=p.toLowerCase(),r=RegExp(" "+s+" ","g"),c=c.replace(r," "+a+" ")}catch(e){}try{c.match(/([a-zA-Z]+ )*[a-zA-Z]+-([a-z]+)( [a-zA-Z]+)*/m)&&(l=(i=c.replace(/([a-zA-Z]+ )*[a-zA-Z]+-([a-z]+)( [a-zA-Z]+)*/gm,"$2")).toTitleCase(),c=c.replace(i,l))}catch(e){}return c},Function.prototype.getName=function(){var e;return null==(e=this.name)&&(e=this.toString().substr(0,this.toString().indexOf("(")).replace("function ","")),isNull(e)&&(e=md5(this.toString())),e},randomInt=function(e,t){var o,r,a;return null==e&&(e=0),null==t&&(t=1),a=Math.random(),null==e&&(e=(o=[0,e])[0],t=o[1]),e>t&&(e=(r=[t,e])[0],t=r[1]),Math.floor(a*(t-e+1)+e)},randomString=function(e){var t,o,r;for(null==e&&(e=8),o=0,65,126,r=[];o<e;)++o,t=randomInt(65,126),r.push(String.fromCharCode(t));return r.join("")},openLink=function(e){return null!=e&&(open(e),!1)},openTab=function(e){return openLink(e)},goTo=function(e){return null!=e&&(location.href=e,!1)},dateMonthToString=function(e){var t,o;t={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};try{o=t[e]}catch(t){o=e}return o},prepURI=function(e){return(e=encodeURIComponent(e)).replace(/%20/g,"+")},(locationData={}).params={enableHighAccuracy:!0},locationData.last=void 0,getLocation=function(e){var t,o,r;return null==e&&(e=void 0),1500,o=function(t){var o;return clearTimeout(r),locationData.lat=t.coords.latitude,locationData.lng=t.coords.longitude,locationData.acc=t.coords.accuracy,o=locationData.last,locationData.last=Date.now(),!(locationData.last-o<1500)&&(console.info("Successfully set location"),"function"==typeof e&&e(locationData),!1)},t=function(t){var o;return clearTimeout(r),o=function(){switch(t.code){case 0:return"There was an error while retrieving your location: "+t.message;case 1:return"The user prevented this page from retrieving a location";case 2:return"The browser was unable to determine your location: "+t.message;case 3:return"The browser timed out retrieving your location."}}(),console.error(o),"function"==typeof e&&e(!1),!1},navigator.geolocation?(console.log("Querying location"),navigator.geolocation.getCurrentPosition(o,t,locationData.params),r=delay(1500,function(){return getLocation(e)})):(console.warn("This browser doesn't support geolocation!"),null!=e?e(!1):void 0)},downloadCSVFile=function(e,t){var o,r,a,n,s,i,l,c,u,p,d,h,y,g,f,m,b,_;if(b=Date.now(),_="",isJson(e)&&"string"==typeof e){console.info("Parsing as JSON string");try{p=JSON.parse(e)}catch(t){throw console.error("COuldn't parse json! "+(a=t).message),console.warn(a.stack),console.info(e),"error"}}else if(isArray(e))console.info("Parsing as array"),p=toObject(e);else{if("object"!=typeof e)return console.error("Unexpected data type '"+typeof e+"' for downloadCSVFile()",e),!1;console.info("Parsing as object"),p=e}for(null==t&&(t={}),null==t.create&&(t.create=!1),null==t.downloadFile&&(t.downloadFile="datalist.csv"),null==t.classes&&(t.classes="btn btn-default"),null==t.buttonText&&(t.buttonText="Download File"),null==t.iconHtml&&(t.iconHtml='<iron-icon icon="icons:cloud-download"></iron-icon>'),null==t.selector&&(t.selector="#download-file"),null==t.splitValues&&(t.splitValues=!1),null==t.cascadeObjects&&(t.cascadeObjects=!1),null==t.objectAsValues&&(t.objectAsValues=!0),l=[],(g=function(o,r){var n,s,i,c,u,p,d,h,y,f,m,b;for(u in y=0,t.objectAsValues&&(t.splitValues="::@@::"),h=[],o)if("function"!=typeof(b=o[u])){++y;try{if(i=u.toString().replace(/"/g,'""'),1===y)if(t.objectAsValues){for(n in console.info("objectAsValues set"),b)e=b[n],isArray(t.acceptableCols)?indexOf.call(t.acceptableCols,n)>=0&&l.push(n):l.push(n);console.log("Using as header",l)}else console.log("Boring options",t.objectAsValues,t),l.push(i);if("object"==typeof b&&r&&(b=g(b,!0)),c=function(e,o){var r,a,n;return null==e&&(e=b),null==o&&(o=t),isNull(b)?r="":("object"==typeof e&&(e=JSON.stringify(e)),a=(a=(a=(e=e.toString()).replace(/,/g,",")).replace(/"/g,'""')).replace(/<\/p><p>/g,'","'),"string"==typeof o.splitValues&&(a=a.split(o.splitValues).join('","'),i=!1),r=a),!1===i?n='"'+r+'"\n':isNumber(i)?n='"'+r+'",':isNull(i)||(n='"'+i+'","'+r+'"\n'),n},t.objectAsValues){for(f=[],p=0,d=l.length;p<d;p++){if(n=l[p],"object"==typeof(s=b[n]))try{s=(s=JSON.stringify(s)).replace(/"/g,'""')}catch(e){}f.push(s)}m=f.join(t.splitValues),h.push(_+=c(m,t))}else h.push(_+=c(b))}catch(e){a=e,console.warn("Unable to run key "+u+" on row "+y,b,o),h.push(console.warn(a.stack))}}return h})(p,t.cascadeObjects),_=_.trim(),d=0,h=0,y=l.length;h<y;h++)r=(r=l[h]).replace(/"/g,'""'),l[d]=r,++d;return t.objectAsValues&&(t.header=l),isArray(t.header)?(c=t.header.join('","'),_=(_='"'+c+'"\n'+_).trim(),i="present"):i="absent",","===_.slice(-1)&&(_=_.slice(0,-1)),s="data:text/csv;charset=utf-8;header="+i+","+encodeURIComponent(_),m=t.selector,!0===t.create?(o=randomInt(0,9999),u='<a id="'+(m.slice(1)+"-download-button-"+o)+'" class="'+t.classes+'" href="'+s+'" download="'+t.downloadFile+'">\n  '+t.iconHtml+"\n  "+t.buttonText+"\n</a>"):u="",f={file:s,options:t,html:u},n=Date.now()-b,console.debug("CSV Worker saved "+n+"ms from main thread"),f},generateCSVFromResults=function(e,t,o){var r,a;null==o&&(o="#modal-sql-details-list"),console.info("Worker CSV: Given",e),r={objectAsValues:!0,downloadFile:"adp-global-search-result-data_"+Date.now()+".csv"};try{a=downloadCSVFile(e,r)}catch(e){console.error("Sorry, there was a problem with this dataset and we can't do that right now."),a={file:"",options:r,html:""}}return a},validateAWebTaxon=function(e,t){var o,r,a;return null==t&&(t=null),null==(void 0!==a&&null!==a?a.validatedTaxons:void 0)&&("object"!=typeof a&&(a={}),a.validatedTaxons=[]),r=function(e){return"function"==typeof t&&t(e),!1},a.validatedTaxons.containsObject(e)?(console.info("Already validated taxon, skipping revalidation",e),r(e),!1):(o="action=validate&genus="+e.genus+"&species="+e.species,null!=e.subspecies&&(o+="&subspecies="+e.subspecies),_adp.currentAsyncJqxhr=$.post("api.php",o,"json").done(function(t){return t.status?(e.genus=t.validated_taxon.genus,e.species=t.validated_taxon.species,e.subspecies=t.validated_taxon.subspecies,null==e.clade&&(e.clade=t.validated_taxon.family),a.validatedTaxons.push(e)):e.invalid=!0,e.response=t,r(e),!1}).fail(function(t,o){var r;return r=e.genus+" "+e.species,r=null!=e.subspecies?r+" "+e.subspecies:r,bsAlert("<strong>Problem validating taxon:</strong> "+r+" couldn't be validated."),console.warn("Warning: Couldn't validated "+r+" with AmphibiaWeb")}),!1)},authorityTest=/^\(? *((['"]?) *(?:(?:\b|[\u00C0-\u017F])[a-z\u00C0-\u017F\u2019 \.\-\[\]\?]+(?:,|,? *&|,? *&amp;| *&amp;amp;| *&(?:[a-z]+|#[0-9]+);)? *)+ *\2) *, *([0-9]{4}) *\)?/gim,yearMatch="$3",authorityMatch="$1",commalessTest=/^(\(?)(.*?[^,]) ([0-9]{4})(\)?)$/gim,progressStepCount=1e3,"object"!=typeof uri&&(uri={urlString:""}),"object"!=typeof _asm&&(_asm={affiliateQueryUrl:{iucnRedlist:"http://apiv3.iucnredlist.org/api/v3/species/common_names/"}}),self.addEventListener("message",function(e){var t,o,r,a;switch(e.data.action){case"render-row":return o=e.data.data,t=isNumber(e.data.chunk)?toInt(e.data.chunk):100,r=null!=(a=e.data.firstIteration.toBool())&&a,renderDataArray(o,r,t);case"render-html":return console.log("Got HTML info from file on thread",e.data),createHtmlFile(e.data.data,e.data.htmlHeader);case"render-csv":return console.log("Got CSV info from file on thread",e.data),createCSVFile(e.data.data);default:return console.error("No valid action recieved from worker initialization!",e.data),console.warn(e)}}),window={},self.importScripts("markdown.min.js"),self.importScripts("markdown.min.js"),markdown=window.markdown,renderDataArray=function(e,t,o){var r,a,n,s,i,l,c,u,p,d,h,y,g,f,m,b,_,w,v,S,N,j,x;for(null==e&&(e=dataArray),null==t&&(t=!0),null==o&&(o=100),u="",[],d="<table id='"+"cndb-result-list"+"' class='table table-striped table-hover col-md-12'>\n\t<tr class='cndb-row-headers'>",p="</table>",r=0,isNumber(o)||(o=100),l=e.length<=o,console.log("Starting loop with i = "+(y=0)+", renderChunk = "+o+", data length = "+e.length,t,l),m=0,b=e.length;m<b;m++){if(v=e[m],y,0===toInt(y)&&t){for(g in 0,d+="\n\x3c!-- Table Headers - "+Object.size(v)+" entries --\x3e",v)v[g],w=g.replace(/_/g," "),d+="\n\t\t<th class='text-center'>"+(w=function(){switch(w){case"simple linnean subgroup":return"Group";case"major subtype":return"Clade";default:return w}}())+"</th>",r++,0;d+="\n\t</tr>",d+="\n\x3c!-- End Table Headers --\x3e",console.log("Got "+r+" display columns."),n="col-md-"+roundNumber(12/r,0),u=d}for(g in j=v.genus+"+"+v.species,isNull(v.subspecies)||(j=j+"+"+v.subspecies),h="\n\t<tr id='"+("msadb-row"+y)+"' class='cndb-result-entry' data-taxon=\""+j+'" data-genus="'+v.genus+'" data-species="'+v.species+'">',v){if(a=v[g],"authority_year"===g)if(isNull(a))s=a;else{try{s=JSON.parse(a),isNumber(s)&&(s=JSON.parse('{"Unk.":"'+s+'"}'))}catch(e){i=e;try{console.warn("There was an error parsing authority_year='"+a+"', attempting to fix - ",i.message),N=a.split(":"),x=(x=N[1].slice(N[1].search('"')+1,-2)).replace(/"/g,"'"),N[1]='"'+x+'"}',a=N.join(":"),s=JSON.parse(a)}catch(e){console.error("There was an error parsing '"+a+"'",(i=e).message),s=a}}try{c=Object.keys(s)[0],S=s[c],toInt(v.parens_auth_genus).toBool()&&(c="("+c+")"),toInt(v.parens_auth_species).toBool()&&(S="("+S+")"),a="G: "+c+"<br/>S: "+S}catch(e){}}"image"===g&&(a=isNull(a)?"<paper-icon-button icon='launch' data-href='"+_asm.affiliateQueryUrl.mammalPhotos+"?rel-taxon=contains&where-taxon="+j+"' class='newwindow calphoto click' data-taxon=\""+j+'"></paper-icon-button>':"<paper-icon-button icon='image:image' data-lightbox='"+uri.urlString+a+"' class='lightboximage'></paper-icon-button>"),f="genus"!==g&&"species"!==g&&"subspecies"!==g?g+" text-center":g,"genus_authority"===g||"species_authority"===g?f+=" authority":"common_name"===g&&(a=smartUpperCasing(a),f+=" no-cap"),h+="\n\t\t<td id='"+g+"-"+y+"' class='"+f+" "+n+"'>"+a+"</td>"}if(u+=h+="\n\t</tr>",++y>=o)break}return console.log("Ended data loop with i = "+y+", renderChunk = "+o),t&&(u+=p),_={html:u,nextChunk:e.slice(y),renderChunk:o,loops:y},self.postMessage(_),self.close()},createHtmlFile=function(e,t){var o,r,a,n,s,i,l,c,u,p,d,h,y,g,f,m,b,_,w,v,S,N,j,x,C,T,O,A,k,F;T=Date.now(),console.debug("Got",e),console.debug("Got body provided?",!isNull(t)),A=e.count,console.debug("Step size",m=A/progressStepCount);try{if(!0!==e.status)throw Error("Invalid Result");for(y in u=[],c=[],p=[],b=e.result){S=b[y];try{y>0&&(0===toInt(modulo(y,m))&&(g={status:!0,done:!1,progress:toInt(y/m)},self.postMessage(g)),0===modulo(y,100)&&0===modulo(y,500)&&(g={status:!0,done:!1,updateUser:"Parsing "+y+" of "+A+", please wait"},self.postMessage(g)))}catch(e){}if(!isNull(S.genus)&&!isNull(S.species)){try{clearTimeout(l),l=delay(250,function(){return console.warn("Possible hang on row #"+y,S),l=delay(1e3,function(){return g={status:!1,done:!1,updateUser:"Failure to parse row "+y},self.postMessage(g),self.close()})})}catch(e){}try{if("object"!=typeof S.authority_year){o={};try{isNumber(S.authority_year)?o[S.authority_year]=S.authority_year:isNull(S.authority_year)?(isJson(S.species_authority)&&(S.species_authority=JSON.stringify(S.species_authority)),S.species_authority=S.species_authority.replace(/(<\/|<|&lt;|&lt;\/).*?(>|&gt;)/gim,""),commalessTest.test(S.species_authority)&&(S.species_authority=S.species_authority.replace(commalessTest,"$1$2, $3$4")),authorityTest.test(S.species_authority)?(F=S.species_authority.replace(authorityTest,yearMatch),S.species_authority=S.species_authority.replace(authorityTest,authorityMatch),o[F]=F,S.authority_year=o):(isNull(S.species_authority)||console.warn("Failed a match on authority '"+S.species_authority+"'"),o.Unknown="Unknown")):o=JSON.parse(S.authority_year)}catch(e){n=e,console.debug("authority isnt number, null, or object, with bad species_authority '"+S.authority_year+"'"),(C=S.authority_year.split(":")).length>1?(F=(F=C[1].slice(C[1].search('"')+1,-2)).replace(/"/g,"'"),C[1]='"'+F+'"}',o=JSON.parse(C.join(":"))):(console.warn("Unable to figure out the type of data for `authority_year`: "+n.message,JSON.stringify(S)),console.warn(n.stack))}}else o=S.authority_year;try{i=Object.keys(o)[0],x=o[i],i=i.toString().replace(/&#39;/g,"'"),x=x.toString().replace(/&#39;/g,"'")}catch(e){for(r in o)k=o[r],i=r.toString().replace(/&#39;/g,"'"),x=k.toString().replace(/&#39;/g,"'")}isNull(S.genus_authority)?S.genus_authority=S.species_authority:isNull(S.species_authority)&&(S.species_authority=S.genus_authority),s=S.genus_authority.toTitleCase()+" "+i,toInt(S.parens_auth_genus).toBool()&&(s="("+s+")"),j=S.species_authority.toTitleCase()+" "+x,toInt(S.parens_auth_species).toBool()&&(j="("+j+")")}catch(e){n=e,console.warn("There was a problem parsing the authority information for _"+S.genus+" "+S.species+" "+S.subspecies+"_ - "+n.message),console.warn(n.stack),console.warn("Bad parse for authority year -- tried to fix >>"+S.authority_year+"<<",o,S.authority_year),console.warn("We were working with",o,i,s,x,j)}if(isNull(S.entry))h="";else try{h=markdown.toHTML(S.entry)}catch(e){n=e,console.warn("Unable to parse Markdown for _"+S.genus+" "+S.species+" "+S.subspecies+"_"),h=S.entry}d="",isNull(h)||isNull(S.taxon_credit)||(O="",isNull(S.taxon_credit_date)||(O=", "+S.taxon_credit_date),d='<p class="text-right small text-muted">\n  <cite>\n    '+S.taxon_credit+O+"\n  </cite>\n</p>"),f="",_=S.linnean_order.trim(),indexOf.call(c,_)<0&&(f+='<h2 class="clade-declaration text-capitalize text-center">'+S.linnean_order+"</h2>",c.push(S.linnean_order.trim())),w=S.linnean_family.trim(),indexOf.call(p,w)<0&&(f+='<h3 class="subclade-declaration text-capitalize text-center">'+S.linnean_family+"</h3>",p.push(S.linnean_family.trim())),v=S.genus,indexOf.call(u,v)<0&&(null==s&&(s=""),f+='<aside class="genus-declaration lead">\n  <span class="entry-sciname text-capitalize">'+S.genus+'</span>\n  <span class="entry-authority">'+(null!=s?s.unescape():void 0)+"</span>\n</aside>",u.push(S.genus)),N=S.genus.slice(0,1)+". ",null==j&&(j=""),t+='<section class="species-entry">\n  '+f+'\n  <p class="h4 entry-header">\n    <span class="entry-sciname">\n      <span class="text-capitalize">'+N+"</span> "+S.species+" "+S.subspecies+'\n    </span>\n    <span class="entry-authority">\n      '+(null!=j?j.unescape():void 0)+'\n    </span>\n    &#8212;\n    <span class="common_name no-cap">\n      '+smartUpperCasing(S.common_name)+'\n    </span>\n  </p>\n  <div class="entry-content">\n    '+h+"\n    "+d+"\n  </div>\n</section>"}}return t+="</article>\n</div>\n</body>\n</html>",g={status:!0,done:!1,progress:progressStepCount},self.postMessage(g),a=Date.now()-T,console.log("HTML file prepped in "+a+"ms off-thread"),g={html:t,status:!0,done:!0},self.postMessage(g),console.debug("Completed worker!"),self.close()}catch(e){return n=e,console.error("There was a problem creating your file. Please try again later."),console.error("Exception in createHtmlFile() - "+n.message),console.warn(n.stack),g={status:!1,done:!0},self.postMessage(g),self.close()}},createCSVFile=function(e){var t,o,r,a,n,s,i,l,c,u,p,d,h,y,g,f,m,b,_,w,v,S,N,j,x,C,T,O,A,k,F,M;O=Date.now(),i="  ",l=[],x=["genus","species","subspecies","canonical_sciname","common_name","common_name_source","image","image_caption","image_credit","image_license","major_type","major_subtype","simple_linnean_group","simple_linnean_subgroup","linnean_order","linnean_family","genus_authority","species_authority","deprecated_scientific","notes","entry","taxon_credit","taxon_credit_date","taxon_author","citation","source","internal_id"],w=["genus","common_name","taxon_credit","linnean_order","linnean_family","genus_authority","species_authority"],o=["parens_auth_genus","parens_auth_species"],f=0,console.debug("Got result"),k=Object.size(e.result),console.debug("Step size",S=k/progressStepCount);try{for(m in N=e.result)if(j=N[m],m>0&&(0===toInt(modulo(m,S))&&(v={status:!0,done:!1,progress:toInt(m/S)},self.postMessage(v)),0===modulo(m,100)&&(console.debug("CSV-ing row "+m+" of "+k),0===modulo(m,500)&&(v={status:!0,done:!1,updateUser:"Parsing "+m+" of "+k+", please wait"},self.postMessage(v)))),c=[],!isNull(j.genus)&&!isNull(j.species)){for(b=0,_=x.length;b<_;b++){p=j[u=x[b]],a=u.replace(/"/g,'""');try{n=p.replace(/"/g,'""').replace(/&#39;/g,"'")}catch(e){n=""}if(0===f&&indexOf.call(x,a)>=0&&l.push(a.replace(/_/g," ").toTitleCase()),indexOf.call(x,a)>=0){if(/[a-z]+_authority/.test(a)){n=n.unescape();try{if("object"!=typeof j.authority_year){t={};try{isNumber(j.authority_year)?t[j.authority_year]=j.authority_year:isNull(j.authority_year)?(j.species_authority=j.species_authority.replace(/(<\/|<|&lt;|&lt;\/).*?(>|&gt;)/gim,""),commalessTest.test(j.species_authority)&&(j.species_authority=j.species_authority.replace(commalessTest,"$1$2, $3$4")),authorityTest.test(j.species_authority)?(M=j.species_authority.replace(authorityTest,yearMatch),j.species_authority=j.species_authority.replace(authorityTest,authorityMatch),t[M]=M,j.authority_year=t):(isNull(j.species_authority)||console.warn("Failed a match on authority '"+j.species_authority+"'"),t.Unknown="Unknown")):t=JSON.parse(j.authority_year)}catch(e){y=e,console.debug("authority isnt number, null, or object, with bad species_authority '"+j.authority_year+"'"),(T=j.authority_year.split(":")).length>1?(M=(M=T[1].slice(T[1].search('"')+1,-2)).replace(/"/g,"'"),T[1]='"'+M+'"}',t=JSON.parse(T.join(":"))):(console.warn("Unable to figure out the type of data for `authority_year`: "+y.message,JSON.stringify(j)),console.warn(y.stack))}}else t=j.authority_year;"string"==typeof j.authority_year&&(j.authority_year=j.authority_year.trim()),isNull(j.authority_year)&&(j.authority_year=JSON.stringify(t));try{g=Object.keys(t)[0],C=t[g],g=g.replace(/&#39;/g,"'"),C=C.replace(/&#39;/g,"'")}catch(e){for(r in t)F=t[r],g=r.replace(/&#39;/g,"'"),C=F.replace(/&#39;/g,"'")}if(isNull(j.genus_authority)?j.genus_authority=j.species_authority+" [assumed]":isNull(j.species_authority)&&(j.species_authority=j.genus_authority),isNull(n)){try{n=j[u].unescape()}catch(e){}(isNull(n)||"[assumed]"===n.trim())&&(n="Unknown")}switch(a.split("_")[0]){case"genus":A=n.toTitleCase()+", "+g,toInt(j.parens_auth_genus).toBool()&&(A="("+A+")");break;case"species":A=n.toTitleCase()+", "+C,toInt(j.parens_auth_species).toBool()&&(A="("+A+")")}n=A}catch(e){y=e}}if("authority_year"===u)if(isNull(n&&!isNull(j[u])))try{"object"==typeof(n=j[u])&&(n=JSON.stringify(n).replace(/"/g,'""'))}catch(e){}else console.debug("auth year '"+n+"' is valid",isNull(n,!isNull(j[u],a,u)));if("deprecated_scientific"===u&&"object"==typeof n&&(n=JSON.stringify(n)),indexOf.call(w,a)>=0&&(n=n.toTitleCase()),"image"!==a||isNull(n)||(n=""+uri.urlString+n),indexOf.call(o,a)>=0)try{n=n.toBool().toString()}catch(e){}c.push('"'+n+'"')}}f++,i+="\n"+c.join(",")}return s=l.join(",")+"\n"+i,d="data:text/csv;charset=utf-8,"+encodeURIComponent(s),v={status:!0,done:!1,progress:progressStepCount},self.postMessage(v),h=Date.now()-O,console.log("CSV file prepped in "+h+"ms off-thread"),v={csv:d,status:!0,done:!0},self.postMessage(v),console.debug("Completed worker!"),self.close()}catch(e){return y=e,console.error("There was a problem creating your file. Please try again later."),console.error("Exception in createCSVFile() - "+y.message),console.warn(y.stack),v={status:!1,done:!0},self.postMessage(v),self.close()}};
//# sourceMappingURL=serviceWorker.min.js.map