var appendCountryLayerToMap,baseQuery,fetchIucnRange,fetchMOLRange,gMapsConfig,getSpeciesAccountLinkout,initMap,setMapHelper,worldPoliticalFusionTableId,indexOf=[].indexOf||function(e){for(var n=0,o=this.length;n<o;n++)if(n in this&&this[n]===e)return n;return-1};gMapsConfig={jsApiKey:"AIzaSyC_qZqVvNk6A6px4Q7BJQOOHqpnQNihSBA",jsApiSrc:"https://maps.googleapis.com/maps/api/js",jsApiInitCallbackFn:null,hasRunInitMap:!1},baseQuery={query:{select:"json_4326",from:worldPoliticalFusionTableId="1uKyspg-HkChMIntZ0N376lMpRzduIjr85UYPpQ"},styles:[{polygonOptions:{fillColor:"#dd2255",strokeColor:"#000",strokeWeight:.05,fillOpacity:.05}}],suppressInfoWindows:!0},"object"==typeof _asm&&(_asm.baseQuery=$.extend({},baseQuery)),appendCountryLayerToMap=function(e,n){var o,a,t,s,i,l,r,c,p,u,g,d,f;if(null==e&&(e={code:"US"}),null==n&&(n=gMapsConfig.map),null==("undefined"!=typeof google&&null!==google?google.maps:void 0))return initMap(function(){return appendCountryLayerToMap(e,n),!1}),!1;if(!(n instanceof google.maps.Map))return console.error("Invalid map object provided"),!1;if(t={code:"postal",postal:"postal",name:"name",country:"name"},c=[],console.debug("Got query obj",e),i=$.extend({},_asm.baseQuery),s=[],"object"==typeof e){o=[];for(a in e)if(f=e[a],indexOf.call(Object.keys(t),a)>=0)if(isArray(f))for(l=0,p=f.length;l<p;l++)g=f[l],o.push("'"+t[a]+"' = '"+g+"'");else o.push("'"+t[a]+"' = '"+f+"'");for(r=0,u=o.length;r<u;r++)d={where:o[r],polygonOptions:{fillColor:"#22dd55",strokeColor:"#22dd55",strokeWeight:1,fillOpacity:.5}},i.styles.push(d);s.push(i),c.push(setMapHelper(new google.maps.FusionTablesLayer(i),n))}else i.query.where=e,i.styles[0]={polygonOptions:{fillColor:"#22dd55",strokeColor:"#22dd55",strokeWeight:1,fillOpacity:.5}},s.push(i),c.push(setMapHelper(new google.maps.FusionTablesLayer(i),n));return{fusionQueries:s,layers:c,mapObj:n}},setMapHelper=function(e,n){return null==n&&(n=gMapsConfig.map),e.setMap(n),e},initMap=function(e,n){var o,a,t,s,i,l,r,c,p,u,g;return null==n&&(n="#species-note"),!0===gMapsConfig.hasRunInitMap?(console.debug("Map already initialized"),"function"==typeof e&&e(),!1):null==("undefined"!=typeof google&&null!==google?google.maps:void 0)?(console.debug("Loading Google Maps first ..."),i=gMapsConfig.jsApiSrc+"?key="+gMapsConfig.jsApiKey,"function"==typeof gMapsConfig.jsApiInitCallbackFn&&(l=[this.getName(),"initMap"],r=gMapsConfig.jsApiInitCallbackFn.getName(),indexOf.call(l,r)<0&&(i+="&callback="+gMapsConfig.jsApiInitCallbackFn.getName())),loadJS(i,function(){return initMap(e,n),!1}),!1):$(n).exists()?($(n).removeClass("col-xs-12").addClass("col-xs-6"),o='<div id="taxon-range-map-container" class="col-xs-6 map-container google-map-container">\n  <div id="taxon-range-map" class="map google-map">\n  </div>\n</div>',$(n).after(o),t={center:{lat:null!=(c=null!=(p=window.locationData)?p.lat:void 0)?c:0,lng:null!=(u=null!=(g=window.locationData)?g.lng:void 0)?u:0},zoom:2},s=$("#taxon-range-map").get(0),a=new google.maps.Map(s,t),gMapsConfig.map=a,gMapsConfig.hasRunInitMap=!0,"function"==typeof e&&e(),a):(console.error("Invalid page layout to init map"),!1)},fetchIucnRange=function(e){var n,o;return null==e&&(e=window._activeTaxon),isNull(e.genus)||isNull(e.species),n={action:"iucn",taxon:e.genus.toTitleCase()+"%20"+e.species,iucn_endpoint:"species/countries/name/"},isNull(e.subspecies)||(n.taxon+="%20"+e.subspecies),o=function(){return fetchMOLRange(e,void 0,!0),!1},$.get("api.php",buildQuery(n,"json")).done(function(e){var a,t,s,i,l,r,c,p,u,g;if(console.log("Got",e),!0!==e.status){console.warn(uri.urlString+"api.php?"+buildQuery(n));try{o()}catch(e){}return!1}if(a=[],(null!=(u=e.response)?u.count:void 0)<=0){console.warn("No results found!");try{o()}catch(e){}return!1}for(s=[],i=0,r=(g=Object.toArray(e.response.result)).length;i<r;i++)-1===(t=g[i]).presence.search(/extinct/i)&&s.push(t);if(0===s.length)return console.warn("This taxon '"+e.response.name+"' is extinct :("),!1;for(l=0,c=s.length;l<c;l++)t=s[l],a.push(t.code);return shuffle(a),p={code:a},console.debug("Taxon exists in "+a.length+" countries...",a),initMap(function(){var e;return console.debug("Map initialized, populating..."),e=appendCountryLayerToMap(p),console.debug("Country layers topped",e)}),!1}).fail(function(e,n){console.error("Couldn't load range map"),console.warn(e,n);try{o()}catch(e){}return!1}),!1},fetchMOLRange=function(e,n,o,a){var t,s,i,l,r,c,p;if(null==e&&(e=window._activeTaxon),null==o&&(o=!1),null==a&&(a="#species-note"),"object"!=typeof e)return console.error("No taxon object specified"),!1;if(i=e,isNull(e.genus)||isNull(e.species))try{r=$(e).attr("data-genus"),p=$(e).attr("data-species"),isNull(n)&&(n=$(e).attr("data-kml")),e={genus:r,species:p}}catch(e){}if(isNull(e.genus)||isNull(e.species))return toastStatusMessage("Unable to show range map"),!1;if(isNull(n)){try{n=$(i).attr("data-kml")}catch(e){}isNull(n)&&console.warn("Unable to read KML attr and none passed")}return l="https://mol.org/species/map/",t={embed:"true"},window._iframeRangeFail=function(){return o?console.debug("Not falling back -- `dontExecuteFallback` set"):(console.warn("We failed to load the MOL range map, doing a fall back to the IUCN/FusionTable map"),$("#taxon-range-map-container.mol-map-container").remove(),fetchIucnRange(e)),!1},c='<div id="taxon-range-map-container" class="col-xs-6 map-container mol-map-container">\n  <iframe class="mol-embed mol-account map" id="species-range-map" src="'+l+e.genus.toTitleCase()+"_"+e.species+"?"+buildQuery(t)+'"  data-taxon-genus="'+e.genus+'" data-taxon-species="'+e.species+'" onerror="_iframeRangeFail()"></iframe>\n</div>',$("#taxon-range-map-container").remove(),$(a).removeClass("col-xs-12").addClass("col-xs-6").after(c),s=delay(7500,function(){return _iframeRangeFail()}),$("#species-range-map").on("load",function(){return clearTimeout(s),!1}),!0},getSpeciesAccountLinkout=function(e,n,o){return null==e&&(e=window._activeTaxon),null==n&&(n="api.php"),null==o&&(o="ol a[href^='pdf']"),$.get(n,"action=get-account").done(function(n){var a,t,s,i,l,r,c,p,u,g,d,f,m,h;if(console.debug("Got response",n),!0!==n.status)return console.error("There was a problem fetching the endpoint content"),console.warn(n),!1;for(f=decode64(n.body_content),(d=n.endpoint.split("/")).pop(),g=d.join("/"),console.debug("Got result!"),l=$(f),console.debug("Got full dom"),i=!1,t=l.find(o),console.debug("Anchor list is "+t.length+" elements long"),_asm.availableTaxaAccounts=[],c=0,p=t.length;c<p;c++)if(a=t[c],s=$(a).text(),m=s.replace(/^(.*?)\s+\(([\w ]+)\)\s*$/gim,"$2").split(" "),h={genus:m[0].toLowerCase(),species:m[1].toLowerCase()},_asm.availableTaxaAccounts.push(h),m[0].toLowerCase()===e.genus.toLowerCase()&&m[1].toLowerCase()===e.species.toLowerCase()){u=g+"/"+$(a).attr("href"),console.log("Found a match: ",u),i=!0,r='<paper-icon-button\n  icon="icons:description"\n  data-href="'+u+'"\n  class="click"\n  data-newtab="true"\n  id="external-species-account"\n  title="View Species Account PDF (Open Access)"\n  data-toggle="tooltip"\n  >\n</paper-icon-button>',$("#species-account h3").after(r),bindClicks("#external-species-account");break}return!0!==i&&console.warn("Found no matching taxon from open-access accounts"),!1}).fail(function(e,o){return console.error("Unable to hit target '"+n+"'"),!1}),!1},_asm.getSpeciesAccountLinkout=getSpeciesAccountLinkout,$(function(){return isNull(window.gMapsLocalKey)||(console.log("Using local unrestricted key"),gMapsConfig.jsApiKey=window.gMapsLocalKey),fetchMOLRange(),getSpeciesAccountLinkout(),!1});
//# sourceMappingURL=speciesAccount.min.js.map